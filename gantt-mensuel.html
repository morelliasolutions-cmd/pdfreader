<!DOCTYPE html>
<html class="light" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta name="theme-color" content="#ea2a33"/>
<link rel="manifest" href="./manifest.json"/>
<title>Diagramme de Gantt Mensuel - Planning</title>
<!-- Material Symbols -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" media="print" onload="this.media='all'"/>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'"/>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js" defer></script>
<!-- Config & API -->
<script src="js/config.js?v=7" defer></script>
<script src="js/api.js?v=7" defer></script>
<script src="js/role-access-control.js?v=1" defer></script>
<!-- Tailwind Config -->
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ea2a33",
                        "primary-dark": "#c82229",
                        "background-light": "#f8f6f6",
                        "background-dark": "#211111",
                        "surface-light": "#ffffff",
                        "surface-dark": "#2a2a2a",
                        "card-light": "#ffffff",
                        "card-dark": "#2a1a1a",
                        "text-dark": "#0f172a",
                        "text-muted": "#64748b",
                        "border-color": "#e2e8f0"
                    },
                    fontFamily: {
                        "display": ["Spline Sans", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        body { font-family: 'Spline Sans', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animation pour le jour actuel */
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        .today-cell {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
</style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- En-t√™te avec navigation mois -->
        <header class="bg-white border-b-2 border-gray-200 shadow-sm sticky top-0 z-30">
            <div class="px-6 py-3">
                <div class="flex items-center justify-between">
                    <!-- Mois √† gauche -->
                    <div class="flex items-center gap-3">
                        <button onclick="changeGanttMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors text-gray-600 hover:text-gray-800">
                            <span class="material-symbols-outlined">chevron_left</span>
                        </button>
                        <h1 class="text-xl font-bold text-gray-800" id="ganttMonthTitle">Janvier 2026</h1>
                        <button onclick="changeGanttMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors text-gray-600 hover:text-gray-800">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                        <button onclick="resetGanttToCurrentMonth()" class="ml-2 px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                            Aujourd'hui
                        </button>
                    </div>
                    
                    <!-- L√©gende √† droite -->
                    <div class="flex items-center gap-5 text-xs">
                        <span class="font-semibold text-gray-600">L√©gende:</span>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-gray-100 border border-gray-300 rounded"></div>
                            <span class="text-gray-700">0 RDV</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-green-200 border border-green-400 rounded"></div>
                            <span class="text-gray-700">1 RDV</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-orange-300 border border-orange-500 rounded"></div>
                            <span class="text-gray-700">2 RDV</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-red-300 border border-red-500 rounded"></div>
                            <span class="text-gray-700">3+ RDV</span>
                        </div>
                        <button onclick="window.close()" class="ml-4 p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Conteneur du diagramme de Gantt avec scroll -->
        <div class="overflow-auto bg-gradient-to-br from-gray-50 to-blue-50/30" style="height: calc(100vh - 70px);">
            <div id="ganttContainer" class="min-w-full">
                <!-- Message de chargement -->
                <div id="loadingMessage" class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
                        <p class="text-gray-600 font-medium">Chargement des donn√©es...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let ganttCurrentMonth = new Date();
        let ganttAppointments = [];
        let ganttTechnicians = [];

        // Fonction pour attendre que Supabase soit initialis√©
        async function waitForSupabase() {
            let attempts = 0;
            console.log('‚è≥ Attente de l\'initialisation de Supabase...');
            
            while (attempts < 50) {
                // V√©rifier si Supabase est initialis√© (client cr√©√© avec m√©thode from)
                if (window.supabase && typeof window.supabase.from === 'function') {
                    console.log('‚úÖ Supabase client initialis√©');
                    return true;
                }
                
                // V√©rifier si la biblioth√®que Supabase est charg√©e mais pas encore le client
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    // La biblioth√®que est l√†, mais le client n'est pas encore cr√©√©
                    // Essayer d'initialiser manuellement si config.js n'a pas encore fait
                    if (window.SUPABASE_CONFIG) {
                        try {
                            const SupabaseLib = window.supabase;
                            window.supabase = SupabaseLib.createClient(
                                window.SUPABASE_CONFIG.url, 
                                window.SUPABASE_CONFIG.anonKey
                            );
                            console.log('‚úÖ Supabase client cr√©√© manuellement');
                            return true;
                        } catch (e) {
                            console.error('Erreur cr√©ation client Supabase:', e);
                        }
                    }
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
                
                if (attempts % 10 === 0) {
                    console.log(`‚è≥ Tentative ${attempts}/50...`);
                }
            }
            
            console.error('‚ùå Supabase non initialis√© apr√®s 5 secondes');
            return false;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üîÑ Initialisation Gantt...');
            
            // Attendre un peu que role-access-control.js ait fini sa v√©rification
            // Si l'utilisateur n'a pas acc√®s, il sera d√©j√† redirig√©
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // V√©rifier que l'utilisateur a bien acc√®s √† cette page (via role-access-control)
            if (window.RoleAccessControl) {
                const role = window.RoleAccessControl.currentUserRole();
                if (role && !window.RoleAccessControl.hasPageAccess('gantt-mensuel.html')) {
                    console.log('‚ùå Acc√®s refus√© pour ce r√¥le:', role);
                    // La redirection devrait d√©j√† avoir √©t√© faite par role-access-control.js
                    // Mais au cas o√π, rediriger vers planif.html qui est autoris√©
                    window.location.href = 'planif.html';
                    return;
                }
                if (role) {
                    console.log('‚úÖ Acc√®s autoris√© pour le r√¥le:', role);
                }
            }
            
            // Attendre que Supabase soit initialis√©
            const supabaseReady = await waitForSupabase();
            
            if (!supabaseReady) {
                console.error('‚ùå Supabase non initialis√© apr√®s 5 secondes');
                alert('Erreur: Supabase non initialis√©. Veuillez recharger la page.');
                return;
            }
            
            // V√©rifier l'authentification
            try {
                if (window.VeloxAPI) {
                    const session = await window.VeloxAPI.getSession();
                    if (!session || !session.user) {
                        console.log('‚ö†Ô∏è Pas de session');
                        // Rediriger vers la page de connexion
                        window.location.href = 'index.html';
                        return;
                    }
                    console.log('‚úÖ Session valide');
                }
            } catch (error) {
                console.error('Erreur authentification:', error);
                // Rediriger vers la page de connexion en cas d'erreur
                window.location.href = 'index.html';
                return;
            }

            // Initialiser le mois √† aujourd'hui
            ganttCurrentMonth = new Date();
            ganttCurrentMonth.setDate(1); // Premier jour du mois
            
            console.log('üìÖ Chargement des donn√©es pour le mois...');
            // Cacher le message de chargement
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) loadingMsg.style.display = 'none';
            
            // Charger les donn√©es et afficher
            await loadGanttData();
            renderGantt();
        });

        // Changer de mois
        async function changeGanttMonth(direction) {
            ganttCurrentMonth.setMonth(ganttCurrentMonth.getMonth() + direction);
            await loadGanttData();
            renderGantt();
        }

        // Revenir au mois actuel
        async function resetGanttToCurrentMonth() {
            ganttCurrentMonth = new Date();
            ganttCurrentMonth.setDate(1);
            await loadGanttData();
            renderGantt();
        }

        // Charger les donn√©es du mois
        async function loadGanttData() {
            try {
                // Mettre √† jour le titre
                const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                                  'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
                const monthTitle = `${monthNames[ganttCurrentMonth.getMonth()]} ${ganttCurrentMonth.getFullYear()}`;
                document.getElementById('ganttMonthTitle').textContent = monthTitle;

                // Calculer le premier et dernier jour du mois
                const firstDay = new Date(ganttCurrentMonth.getFullYear(), ganttCurrentMonth.getMonth(), 1);
                const lastDay = new Date(ganttCurrentMonth.getFullYear(), ganttCurrentMonth.getMonth() + 1, 0);
                const firstDayStr = firstDay.toISOString().split('T')[0];
                const lastDayStr = lastDay.toISOString().split('T')[0];

                // V√©rifier que Supabase est disponible
                if (!window.supabase || typeof window.supabase.from !== 'function') {
                    console.error('‚ùå Supabase client non disponible');
                    console.log('window.supabase:', window.supabase);
                    console.log('window.SUPABASE_CONFIG:', window.SUPABASE_CONFIG);
                    
                    // Essayer de cr√©er le client manuellement si SUPABASE_CONFIG existe
                    if (window.SUPABASE_CONFIG && window.supabase && typeof window.supabase.createClient === 'function') {
                        console.log('üîÑ Tentative de cr√©ation manuelle du client Supabase...');
                        const SupabaseLib = window.supabase;
                        window.supabase = SupabaseLib.createClient(
                            window.SUPABASE_CONFIG.url, 
                            window.SUPABASE_CONFIG.anonKey
                        );
                        console.log('‚úÖ Client Supabase cr√©√© manuellement');
                    } else {
                        throw new Error('Supabase client non initialis√©. V√©rifiez que js/config.js est charg√©.');
                    }
                }
                
                console.log('‚úÖ Supabase client disponible, chargement des techniciens...');

                // Charger tous les techniciens actifs
                const { data: employees, error: employeesError } = await window.supabase
                    .from('employees')
                    .select('id, first_name, last_name, type')
                    .eq('status', 'Actif')
                    .eq('type', 'Technicien')
                    .order('last_name');

                if (employeesError) {
                    console.error('Erreur chargement techniciens:', employeesError);
                    throw employeesError;
                }
                ganttTechnicians = employees || [];

                // Charger tous les rendez-vous du mois
                const { data: appointments, error: appointmentsError } = await window.supabase
                    .from('appointments')
                    .select('*')
                    .gte('date', firstDayStr)
                    .lte('date', lastDayStr);

                if (appointmentsError) {
                    console.error('Erreur chargement rendez-vous:', appointmentsError);
                    throw appointmentsError;
                }
                ganttAppointments = appointments || [];

                console.log(`‚úÖ Gantt: ${ganttAppointments.length} rendez-vous charg√©s pour ${monthTitle}`);
            } catch (error) {
                console.error('Erreur chargement donn√©es Gantt:', error);
                const errorMessage = error.message || 'Erreur inconnue';
                const errorDetails = error.details || error.hint || '';
                
                // Afficher l'erreur dans le conteneur
                const container = document.getElementById('ganttContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center p-8 bg-red-50 rounded-lg border-2 border-red-200 max-w-md">
                                <span class="material-symbols-outlined text-red-600 text-5xl mb-4">error</span>
                                <h3 class="text-xl font-bold text-red-800 mb-2">Erreur de chargement</h3>
                                <p class="text-red-700 mb-4">${errorMessage}</p>
                                ${errorDetails ? `<p class="text-sm text-red-600 mb-4">${errorDetails}</p>` : ''}
                                <button onclick="location.reload()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                    Recharger la page
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    alert(`Erreur lors du chargement des donn√©es: ${errorMessage}\n\nV√©rifiez la console pour plus de d√©tails.`);
                }
            }
        }

        // Rendre le diagramme de Gantt
        function renderGantt() {
            const container = document.getElementById('ganttContainer');
            if (!container) return;

            // Calculer les jours du mois
            const year = ganttCurrentMonth.getFullYear();
            const month = ganttCurrentMonth.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Cr√©er la structure HTML
            let html = `
                <div class="bg-white">
                    <!-- En-t√™te avec les techniciens -->
                    <div class="sticky top-0 z-20 bg-blue-600 shadow-md border-b-2 border-blue-500">
                        <div class="flex">
                            <!-- Colonne fixe pour les jours -->
                            <div class="sticky left-0 z-30 bg-blue-600 border-r-2 border-blue-500 w-28 flex items-center justify-center font-bold text-white py-2.5 text-xs shadow-sm">
                                <span>Jour / Tech</span>
                            </div>
                            <!-- En-t√™tes des techniciens -->
                            <div class="flex flex-1 overflow-x-auto">
                                ${ganttTechnicians.map(tech => `
                                    <div class="min-w-[100px] border-r border-blue-500 bg-blue-600 px-2 py-2 text-center">
                                        <div class="font-semibold text-xs text-blue-100 truncate uppercase tracking-wider" title="${tech.first_name} ${tech.last_name}">
                                            ${tech.first_name} ${tech.last_name.charAt(0)}.
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Corps du tableau avec les jours -->
                    <div class="divide-y divide-gray-200">
            `;

            // Cr√©er une ligne pour chaque jour du mois (hauteur r√©duite)
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();
                const dayName = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][dayOfWeek];
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = dateStr === new Date().toISOString().split('T')[0];

                html += `
                    <div class="flex hover:bg-blue-50 transition-colors ${isToday ? 'bg-blue-50 ring-2 ring-blue-400 today-cell' : ''}" style="min-height: 32px;">
                        <!-- Colonne fixe avec le jour -->
                        <div class="sticky left-0 z-10 bg-blue-50 border-r-2 border-blue-400 w-28 px-2 py-1 flex items-center justify-between ${isToday ? 'bg-blue-100 font-bold ring-2 ring-blue-400' : ''} group hover:bg-blue-100 transition-colors">
                            <div class="flex flex-col">
                                <div class="text-xs font-semibold text-gray-800 leading-tight ${isToday ? 'text-blue-700' : ''}">${dayName}</div>
                                <div class="text-xs text-gray-600 leading-tight ${isToday ? 'text-blue-600 font-semibold' : ''}">${day}</div>
                            </div>
                        </div>
                        <!-- Cellules pour chaque technicien -->
                        <div class="flex flex-1 overflow-x-auto">
                            ${ganttTechnicians.map(tech => {
                                // Compter les rendez-vous pour ce technicien et ce jour
                                const appointmentsForDay = ganttAppointments.filter(apt => 
                                    apt.date === dateStr && apt.employee_id === tech.id
                                );
                                const count = appointmentsForDay.length;

                                // D√©terminer la couleur selon le nombre
                                let bgColor = 'bg-gray-100';
                                let borderColor = 'border-gray-300';
                                let textColor = 'text-gray-600';
                                
                                if (count === 0) {
                                    bgColor = 'bg-gray-50';
                                    borderColor = 'border-gray-200';
                                    textColor = 'text-gray-400';
                                } else if (count === 1) {
                                    bgColor = 'bg-green-200';
                                    borderColor = 'border-green-400';
                                    textColor = 'text-green-800';
                                } else if (count === 2) {
                                    bgColor = 'bg-orange-300';
                                    borderColor = 'border-orange-500';
                                    textColor = 'text-orange-900';
                                } else {
                                    // 3 RDV ou plus
                                    bgColor = 'bg-red-300';
                                    borderColor = 'border-red-500';
                                    textColor = 'text-red-900';
                                }

                                return `
                                    <div class="min-w-[100px] border-r border-blue-200 px-1 py-1 ${isWeekend ? 'bg-gray-50/50' : ''}">
                                        <div class="border-2 ${borderColor} ${bgColor} rounded-lg px-1 py-0.5 text-center cursor-pointer hover:shadow-lg hover:scale-105 transition-all h-full flex flex-col justify-center shadow-sm" 
                                             title="${count} rendez-vous le ${day}/${month + 1}" 
                                             onclick="showGanttDayDetails('${dateStr}', '${tech.id}', '${tech.first_name} ${tech.last_name}')">
                                            <div class="text-lg font-bold ${textColor} leading-tight">${count}</div>
                                            <div class="text-[10px] ${textColor} leading-tight font-medium">RDV</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Afficher les d√©tails d'un jour pour un technicien
        function showGanttDayDetails(dateStr, techId, techName) {
            const appointments = ganttAppointments.filter(apt => 
                apt.date === dateStr && apt.employee_id === techId
            );

            if (appointments.length === 0) {
                alert(`Aucun rendez-vous pour ${techName} le ${dateStr}`);
                return;
            }

            const date = new Date(dateStr);
            const dateFormatted = date.toLocaleDateString('fr-FR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            let details = `üìÖ ${dateFormatted}\nüë§ ${techName}\n\n`;
            details += `Rendez-vous (${appointments.length}):\n\n`;

            appointments.forEach((apt, index) => {
                details += `${index + 1}. ${apt.start_time || 'N/A'} - ${apt.end_time || 'N/A'}\n`;
                details += `   üìç ${apt.address || 'N/A'}, ${apt.npa || ''} ${apt.city || ''}\n`;
                if (apt.mandate_number) {
                    details += `   üè∑Ô∏è Mandat: ${apt.mandate_number}\n`;
                }
                details += `\n`;
            });

            alert(details);
        }
    </script>
</body>
</html>
