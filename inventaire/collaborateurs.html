<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Collaborateurs - Gestionnaire de Stock</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter%3Awght%40400%3B500%3B700%3B900&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../js/config.js?v=8"></script>
<script src="../js/api.js?v=8"></script>
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#137fec",
          "background-light": "#f6f7f8",
          "background-dark": "#101922",
        },
        fontFamily: {
          display: ["Inter"],
        },
        borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
      },
    },
  };
</script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<style>
  @media print {
    body { background: white !important; }
    .no-print { display: none !important; }
    .print-content { padding: 0; max-width: 100%; }
    table { font-size: 9pt !important; width: 100%; }
    thead th { padding: 4px !important; background: #f3f4f6 !important; }
    tbody td { padding: 3px 4px !important; }
  }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">

<div id="loading"></div>

<div id="main-content" style="display: none;" class="flex flex-col min-h-screen">
  <!-- Navigation bar horizontale -->
  <nav class="bg-white dark:bg-background-dark/50 border-b border-gray-200 dark:border-gray-800">
    <div class="px-6 py-4 flex items-center justify-between">
      <!-- Logo à gauche -->
      <div class="flex items-center gap-3">
        <img id="logo" src="" alt="Logo" class="h-8 w-auto" style="display:none;" onerror="this.style.display='none'" />
        <span class="text-xl font-bold text-primary">Gestionnaire de Stock</span>
      </div>
      
      <!-- Menu du milieu -->
      <div class="flex items-center gap-1">
        <a href="inventaire.html" class="nav-link px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary dark:hover:bg-primary/20 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined">warehouse</span>
          <span>Inventaire</span>
        </a>
        <a href="collaborateurs.html" class="nav-link px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary dark:hover:bg-primary/20 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined">group</span>
          <span>Technicien</span>
        </a>
        <a href="vehicule.html" class="nav-link px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary dark:hover:bg-primary/20 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined">directions_car</span>
          <span>Véhicules</span>
        </a>
        <a href="commandes.html" class="nav-link px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary dark:hover:bg-primary/20 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined">shopping_cart</span>
          <span>Commandes</span>
        </a>
      </div>
      
      <!-- Profil utilisateur à droite -->
      <div class="flex items-center gap-3 relative">
        <div class="text-right">
          <p id="user-name" class="text-sm font-medium text-gray-900 dark:text-white">Chargement...</p>
          <p id="user-role" class="text-xs text-gray-500 dark:text-gray-400">Utilisateur</p>
        </div>
        <div id="profile-btn" class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center text-white font-bold cursor-pointer hover:shadow-lg transition-shadow">
          <span id="user-initials">...</span>
        </div>
        
        <!-- Menu déroulant -->
        <div id="profile-menu" class="absolute top-full right-0 mt-2 w-48 bg-white dark:bg-background-dark/50 rounded-lg shadow-lg border border-gray-200 dark:border-gray-800 hidden z-50">
          <a href="parametres.html" class="block px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary dark:hover:bg-primary/20 rounded-t-lg flex items-center gap-2 transition-colors">
            <span class="material-symbols-outlined text-base">settings</span>
            <span>Paramètres</span>
          </a>
          <div class="border-t border-gray-200 dark:border-gray-700"></div>
          <button class="w-full text-left px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-600 dark:hover:text-red-400 rounded-b-lg flex items-center gap-2 transition-colors">
            <span class="material-symbols-outlined text-base">logout</span>
            <span>Déconnexion</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Contenu principal -->
  <div class="flex-1 p-6 max-w-7xl mx-auto w-full">
    <!-- En-tête -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Techniciens</h1>
      
      <!-- Statistiques -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white dark:bg-background-dark/50 rounded-lg p-6 border border-gray-200 dark:border-gray-800">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Total Techniciens</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-white" id="total-count">0</p>
            </div>
            <span class="material-symbols-outlined text-4xl text-primary/30">groups</span>
          </div>
        </div>
        <div class="bg-white dark:bg-background-dark/50 rounded-lg p-6 border border-gray-200 dark:border-gray-800">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Moyenne Prix/Tech</p>
              <p class="text-3xl font-bold text-blue-600" id="avg-price-per-tech">0.00 CHF</p>
            </div>
            <span class="material-symbols-outlined text-4xl text-blue-500/30">trending_up</span>
          </div>
        </div>
        <div class="bg-white dark:bg-background-dark/50 rounded-lg p-6 border border-gray-200 dark:border-gray-800">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Prix Total Inventaires</p>
              <p class="text-3xl font-bold text-orange-600" id="total-price">0.00 CHF</p>
            </div>
            <span class="material-symbols-outlined text-4xl text-orange-500/30">payments</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Recherche -->
    <div class="mb-6">
      <div class="relative">
        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
        <input id="search-input" class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark/50 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-gray-900 dark:text-white" placeholder="Rechercher un technicien..." type="text"/>
      </div>
    </div>

    <!-- Tableau des techniciens -->
    <div class="bg-white dark:bg-background-dark/50 rounded-lg border border-gray-200 dark:border-gray-800 overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-50 dark:bg-background-dark/80 border-b border-gray-200 dark:border-gray-800">
          <tr>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-white">Nom</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-white">Prénom</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-white">Statut</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-white">Prix Total</th>
            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-900 dark:text-white">Matériel</th>
            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-900 dark:text-white">Actions</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">Chargement...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal détail technicien avec matériel -->
<div id="detail-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-background-dark rounded-xl shadow-2xl max-w-6xl w-full max-h-[95vh] overflow-hidden flex flex-col border border-gray-200 dark:border-gray-800">
    <!-- Header avec gradient -->
    <div class="bg-gradient-to-r from-primary to-primary/80 p-6 text-white">
      <div class="flex items-center justify-between">
        <div>
          <h2 id="detail-name" class="text-3xl font-bold mb-1"></h2>
          <p id="detail-email" class="text-sm text-white/90"></p>
        </div>
        <div class="flex gap-2">
          <button onclick="openAddEquipmentModal()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition-all backdrop-blur-sm">
            <span class="material-symbols-outlined text-lg">add</span>
            <span>Ajouter matériel</span>
          </button>
          <button onclick="printEquipmentList()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition-all backdrop-blur-sm">
            <span class="material-symbols-outlined text-lg">print</span>
            <span>Imprimer</span>
          </button>
          <button id="close-detail-modal" class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg transition-all">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
        </div>
        </div>

    <!-- Onglets -->
    <div class="border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
      <div class="flex">
        <button onclick="switchTab('inventory')" id="tab-inventory" class="tab-button px-6 py-4 font-semibold text-gray-700 dark:text-gray-300 border-b-2 border-primary transition-all">
          <span class="material-symbols-outlined align-middle mr-2">inventory_2</span>
          Inventaire Matériel
        </button>
        <button onclick="switchTab('movements')" id="tab-movements" class="tab-button px-6 py-4 font-semibold text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-primary transition-all">
          <span class="material-symbols-outlined align-middle mr-2">swap_horiz</span>
          Mouvements de Stock
        </button>
      </div>
    </div>

    <!-- Contenu avec scroll -->
    <div class="flex-1 overflow-y-auto p-6">
      <!-- Onglet Inventaire -->
      <div id="tab-content-inventory" class="tab-content">
        <div id="equipment-list-container" class="print-content">
          <div class="mb-6">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
              Le matériel scanné via l'application mobile apparaît automatiquement ici.
            </p>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50 dark:bg-gray-900/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Retour</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Référence</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Nom</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Catégorie</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Qté</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Dépôt</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Scanné le</th>
                  <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider no-print">Actions</th>
                </tr>
              </thead>
              <tbody id="equipment-list-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                <tr>
                  <td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Aucun matériel assigné. Le matériel scanné via l'application mobile apparaîtra ici.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Section signatures supprimée du HTML car générée dynamiquement à l'impression -->
        </div>
      </div>

      <!-- Onglet Mouvements -->
      <div id="tab-content-movements" class="tab-content hidden">
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Historique des Mouvements</h3>
            <div class="flex gap-4">
              <select id="movement-filter-type" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="">Tous les types</option>
                <option value="sortie">Sortie</option>
                <option value="installation">Installé</option>
                <option value="retour">Retour</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <input type="text" id="movement-search" placeholder="Rechercher par référence, nom, technicien..." class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          
          <!-- Stats -->
          <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
              <p class="text-sm text-blue-600 dark:text-blue-400 font-medium mb-1">Total Sorties</p>
              <p id="stat-total-sorties" class="text-2xl font-bold text-blue-900 dark:text-blue-100">0</p>
            </div>
            <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg border border-indigo-200 dark:border-indigo-800">
              <p class="text-sm text-indigo-600 dark:text-indigo-400 font-medium mb-1">Total Installés</p>
              <p id="stat-total-installations" class="text-2xl font-bold text-indigo-900 dark:text-indigo-100">0</p>
            </div>
            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-800">
              <p class="text-sm text-green-600 dark:text-green-400 font-medium mb-1">Total Retours</p>
              <p id="stat-total-retours" class="text-2xl font-bold text-green-900 dark:text-green-100">0</p>
            </div>
            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-200 dark:border-purple-800">
              <p class="text-sm text-purple-600 dark:text-purple-400 font-medium mb-1">Prix moyen / Install</p>
              <p id="stat-en-circulation" class="text-2xl font-bold text-purple-900 dark:text-purple-100">0.00 CHF</p>
            </div>
          </div>

          <!-- Table des mouvements -->
          <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50 dark:bg-gray-900/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Date</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Type</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Technicien</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Référence</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Nom</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Qté</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Dépôt</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Chantier</th>
                </tr>
              </thead>
              <tbody id="movements-list-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                <tr>
                  <td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Chargement des mouvements...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal ajouter matériel depuis inventaire -->
<div id="add-equipment-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-background-dark/90 rounded-lg max-w-2xl w-full border border-gray-200 dark:border-gray-800">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Ajouter du matériel depuis l'inventaire</h2>
        <button id="close-add-equipment-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      
      <form id="add-equipment-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Dépôt *</label>
          <select id="add-equipment-depot" required class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
            <option value="">Sélectionner un dépôt...</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Article *</label>
          <select id="add-equipment-item" required class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
            <option value="">Sélectionner un article...</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quantité *</label>
          <input type="number" id="add-equipment-quantity" required min="1" value="1" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
      </div>
        
      <div class="flex gap-3 pt-4">
          <button type="submit" class="flex-1 bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary/90">
            Ajouter
          </button>
          <button type="button" id="cancel-add-equipment" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600">
            Annuler
          </button>
      </div>
    </form>
    </div>
  </div>
</div>

<script>
// Variables globales
let allTechnicians = [];
let currentTechnicianId = null;
let currentTechnicianEquipment = [];
let allDepots = [];
let allInventoryItems = [];

// Fonctions de chargement
function showLoading(message = 'Chargement...') {
  const loadingDiv = document.getElementById('loading');
  const mainContent = document.getElementById('main-content');
  if (loadingDiv) {
    loadingDiv.innerHTML = 
      '<div class="flex items-center justify-center min-h-screen bg-background-light dark:bg-background-dark">' +
        '<div class="text-center">' +
          '<div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>' +
          '<p class="text-gray-600 dark:text-gray-400">' + message + '</p>' +
        '</div>' +
      '</div>';
    loadingDiv.style.display = 'block';
  }
  if (mainContent) {
    mainContent.style.display = 'none';
  }
}

function hideLoading() {
  const loadingDiv = document.getElementById('loading');
  const mainContent = document.getElementById('main-content');
  if (loadingDiv) {
    loadingDiv.style.display = 'none';
  }
  if (mainContent) {
    mainContent.style.display = 'block';
  }
}

// Charger les techniciens depuis employees
async function loadTechnicians() {
  if (!window.supabase || typeof window.supabase.from !== 'function') {
    console.error('Supabase non initialisé');
    return;
  }
  
  try {
    const { data, error } = await window.supabase
      .from('employees')
      .select('*')
      .eq('type', 'Technicien')
      .order('last_name');
    
    if (error) throw error;
    
    allTechnicians = data || [];
    
    // Charger le matériel pour chaque technicien avec les prix
    // On doit maintenant prendre en compte tout le matériel NON retourné, puis soustraire ce qui est installé
    for (const tech of allTechnicians) {
      // 1. Récupérer tout le matériel "assigné" (non marqué comme retourné)
      const { data: equipment } = await window.supabase
        .from('employee_equipment')
        .select('*')
        .eq('employee_id', tech.id)
        .eq('returned', false);
        
      // 2. Récupérer les installations effectuées par le technicien
      const { data: interventions } = await window.supabase
        .from('intervention_details')
        .select('materials')
        .eq('technician_id', tech.id)
        .not('materials', 'is', null);

      // Calculer les quantités installées par item_id
      const installsByItem = {};
      // Map pour mapping equipment_id -> inventory_item_id
      const equipIdToInvId = {};
      const refToInvId = {}; // Map de secours pour référence
      if (equipment) {
        equipment.forEach(eq => {
          if (eq.id && eq.inventory_item_id) {
            equipIdToInvId[eq.id] = eq.inventory_item_id;
          }
          if (eq.reference && eq.inventory_item_id) {
            refToInvId[eq.reference] = eq.inventory_item_id;
          }
        });
      }

      if (interventions) {
        interventions.forEach(intervention => {
          if (Array.isArray(intervention.materials)) {
            intervention.materials.forEach(mat => {
              let itemId = mat.inventory_item_id;
              if (!itemId && mat.equipment_id) {
                itemId = equipIdToInvId[mat.equipment_id];
              }
              // Fallback sur la référence si l'ID d'équipement échoue
              if (!itemId && mat.reference) {
                itemId = refToInvId[mat.reference];
              }
              
              if (itemId) {
                const qty = parseFloat(mat.quantity) || 1;
                installsByItem[itemId] = (installsByItem[itemId] || 0) + qty;
              }
            });
          }
        });
      }

      // Appliquer la logique de déduction FIFO pour calculer le "Net en main"
      let netEquipmentList = [];
      if (equipment && equipment.length > 0) {
        // Trier par date pour FIFO
        const sortedEquipment = [...equipment].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        
        sortedEquipment.forEach(item => {
          const itemId = item.inventory_item_id;
          if (!itemId) return;

          let qty = item.quantity || 1;
          const installedQty = installsByItem[itemId] || 0;

          if (installedQty > 0) {
            const toDeduct = Math.min(qty, installedQty);
            installsByItem[itemId] -= toDeduct;
            qty -= toDeduct;
          }

          if (qty > 0) {
            netEquipmentList.push({ ...item, quantity: qty }); // Quantité restante réelle
          }
        });
      }

      // Mise à jour du compteur pour l'affichage
      tech.equipment_count = netEquipmentList.length; // Nombre de "lignes" restantes
      // Ou on peut faire la somme des quantités :
      const totalUnits = netEquipmentList.reduce((sum, item) => sum + (item.quantity || 0), 0);
      
      // Récupérer les prix pour calculer la valeur totale
      let totalPrice = 0;
      if (netEquipmentList.length > 0) {
        const inventoryItemIds = netEquipmentList.map(eq => eq.inventory_item_id).filter(Boolean);
        if (inventoryItemIds.length > 0) {
          const { data: inventoryItems } = await window.supabase
            .from('inventory_items')
            .select('id, price')
            .in('id', inventoryItemIds);
          
          const priceMap = {};
          inventoryItems?.forEach(item => {
            priceMap[item.id] = (typeof item.price === 'number') ? item.price : parseFloat(item.price || 0);
          });
          
          netEquipmentList.forEach(eq => {
            const price = priceMap[eq.inventory_item_id] || 0;
            // Toujours s'assurer que la quantité est un nombre
            const quantity = (typeof eq.quantity === 'number') ? eq.quantity : parseFloat(eq.quantity || 1);
            totalPrice += price * quantity;
          });
        }
      }
      tech.equipment_total_price = totalPrice;
      tech.equipment_units_count = totalUnits; // Stocker info utile
    }
    
    updateStats();
    renderTable(allTechnicians);
  } catch (error) {
    console.error('Erreur chargement techniciens:', error);
    alert('Erreur lors du chargement des techniciens: ' + error.message);
  }
}

// Mettre à jour les statistiques (avec données filtrées optionnelles)
function updateStats(filteredData = null) {
  const dataToUse = filteredData || allTechnicians;
  const total = dataToUse.length;
  
  // Calculer le prix total des inventaires
  let totalPrice = 0;
  dataToUse.forEach(tech => {
    totalPrice += tech.equipment_total_price || 0;
  });

  // Calculer la moyenne
  const avgPrice = total > 0 ? totalPrice / total : 0;
  
  document.getElementById('total-count').textContent = total;
  
  const avgElement = document.getElementById('avg-price-per-tech');
  if (avgElement) {
    avgElement.textContent = avgPrice.toFixed(2) + ' CHF';
  }
  
  document.getElementById('total-price').textContent = totalPrice.toFixed(2) + ' CHF';
}

// Afficher le tableau
function renderTable(data) {
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';
  
  if (data.length === 0) {
    tbody.innerHTML = 
      '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">Aucun technicien trouvé.</td></tr>';
    return;
  }
  
  data.forEach(tech => {
    const tr = document.createElement('tr');
    tr.className = 'border-b dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-900/50';
    
    const statusColor = tech.status === 'Actif' 
      ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'
      : 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
    
    const techId = tech.id || '';
    const lastName = tech.last_name || '-';
    const firstName = tech.first_name || '-';
    const techStatus = tech.status || 'Actif';
    const totalPrice = tech.equipment_total_price || 0;
    const priceText = totalPrice.toFixed(2) + ' CHF';
    // Utiliser le nombre d'unités plutôt que le nombre de lignes
    const eqCount = tech.equipment_units_count !== undefined ? tech.equipment_units_count : (tech.equipment_count || 0);
    const eqCountText = eqCount + ' article' + (eqCount !== 1 ? 's' : '');
    const eqCountColor = eqCount > 0 
      ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200'
      : 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400';
    
    tr.innerHTML = 
      '<td class="px-6 py-4 font-medium text-gray-900 dark:text-white">' + lastName + '</td>' +
      '<td class="px-6 py-4 text-gray-700 dark:text-gray-300">' + firstName + '</td>' +
      '<td class="px-6 py-4">' +
        '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + statusColor + '">' +
          techStatus +
        '</span>' +
      '</td>' +
      '<td class="px-6 py-4 text-gray-700 dark:text-gray-300 font-medium">' + priceText + '</td>' +
      '<td class="px-6 py-4 text-center">' +
        '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + eqCountColor + '">' +
          eqCountText +
        '</span>' +
      '</td>' +
      '<td class="px-6 py-4 text-right">' +
        '<button onclick="viewEquipment(\'' + techId + '\')" class="text-primary hover:underline flex items-center gap-1">' +
          '<span class="material-symbols-outlined text-base">inventory_2</span>' +
          '<span>Voir inventaire</span>' +
        '</button>' +
      '</td>';
    tbody.appendChild(tr);
  });
}

// Voir l'inventaire d'un technicien
async function viewEquipment(employeeId) {
  currentTechnicianId = employeeId;
  const tech = allTechnicians.find(t => t.id === employeeId);
  if (!tech) return;
  
  // Afficher les infos du technicien
  document.getElementById('detail-name').textContent = (tech.first_name || '') + ' ' + (tech.last_name || '');
  document.getElementById('detail-email').textContent = tech.email || '';
  
  // Mettre à jour la date d'impression si l'élément existe
  const printDateEl = document.getElementById('print-date');
  if (printDateEl) {
    printDateEl.textContent = 'Date: ' + new Date().toLocaleDateString('fr-FR');
  }
  
  // Charger le matériel
  try {
    // 1. Récupérer tout le matériel assigné (historique complet)
    const { data: equipmentData, error: equipmentError } = await window.supabase
      .from('employee_equipment')
      .select(`
        *,
        inventory_items (
          name,
          category,
          photo
        ),
        depots (
          name
        )
      `)
      .eq('employee_id', employeeId)
      .order('created_at', { ascending: false });
    
    if (equipmentError) throw equipmentError;
    
    // 2. Récupérer les interventions du technicien pour identifier le matériel installé
    const { data: interventions, error: interventionsError } = await window.supabase
      .from('intervention_details')
      .select('materials')
      .eq('technician_id', employeeId)
      .not('materials', 'is', null);

    if (interventionsError) console.error('Erreur chargement interventions:', interventionsError);

    // 3. Calculer les quantités installées par type d'article (inventory_item_id)
    const installsByItem = {}; // { itemId: quantity_installed }
    
    // Map pour retrouver l'inventory_item_id à partir de l'equipment_id si nécessaire
    const equipIdToInvId = {};
    if (equipmentData) {
      equipmentData.forEach(eq => {
        if (eq.id && eq.inventory_item_id) {
          equipIdToInvId[eq.id] = eq.inventory_item_id;
        }
      });
    }

    if (interventions) {
      interventions.forEach(intervention => {
        if (Array.isArray(intervention.materials)) {
          intervention.materials.forEach(mat => {
            // Essayer de trouver l'ID de l'article d'inventaire
            let itemId = mat.inventory_item_id;
            
            // Si pas présent, essayer via equipment_id
            if (!itemId && mat.equipment_id) {
              itemId = equipIdToInvId[mat.equipment_id];
            }

            // Si toujours pas trouvé, on pourrait essayer par référence, mais restons sûrs pour le moment.
            // Si on a l'ID, on incrémente le compteur d'installation
            if (itemId) {
              const qty = parseFloat(mat.quantity) || 1;
              installsByItem[itemId] = (installsByItem[itemId] || 0) + qty;
            }
          });
        }
      });
    }

    // 4. Filtrer et ajuster les quantités selon la logique FIFO (Premier Sortie du Stock, Premier Installé)
    // On trie par date croissante (plus vieux d'abord) pour consommer le "vieux" stock en priorité
    const sortedEquipment = [...(equipmentData || [])].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    const finalDisplayList = [];

    sortedEquipment.forEach(item => {
      // Si l'objet est déjà marqué retourné physiquement, on l'ignore (plus en possession)
      if (item.returned) return;

      const itemId = item.inventory_item_id;
      if (!itemId) return;

      let qty = item.quantity || 1;
      const installedQty = installsByItem[itemId] || 0;

      if (installedQty > 0) {
        // On déduit la quantité installée de ce lot spécifique
        const toDeduct = Math.min(qty, installedQty);
        
        // On réduit la "dette" d'installation
        installsByItem[itemId] -= toDeduct;
        
        // On réduit la quantité disponible dans ce lot
        qty -= toDeduct;
      }

      // S'il reste de la quantité dans ce lot, on l'affiche
      if (qty > 0) {
        // On clone pour ne pas modifier l'original si utilisé ailleurs et on met à jour la quantité
        finalDisplayList.push({ ...item, quantity: qty });
      }
    });

    // 5. Retrier par date décroissante pour l'affichage (plus récent en haut)
    currentTechnicianEquipment = finalDisplayList.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    renderEquipmentList(currentTechnicianEquipment);
    
    // Charger les mouvements de stock (Historique complet)
    await loadStockMovements(employeeId);
    
    // Ouvrir le modal et afficher l'onglet inventaire par défaut
    switchTab('inventory');
    document.getElementById('detail-modal').classList.remove('hidden');
  } catch (error) {
    console.error('Erreur chargement matériel:', error);
    alert('Erreur lors du chargement du matériel: ' + error.message);
  }
}

// Changer d'onglet
function switchTab(tabName) {
  // Masquer tous les contenus
  document.getElementById('tab-content-inventory').classList.add('hidden');
  document.getElementById('tab-content-movements').classList.add('hidden');
  
  // Retirer l'état actif de tous les onglets
  document.getElementById('tab-inventory').classList.remove('border-primary', 'text-gray-900', 'dark:text-white');
  document.getElementById('tab-inventory').classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
  document.getElementById('tab-movements').classList.remove('border-primary', 'text-gray-900', 'dark:text-white');
  document.getElementById('tab-movements').classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
  
  // Afficher le contenu sélectionné
  if (tabName === 'inventory') {
    document.getElementById('tab-content-inventory').classList.remove('hidden');
    document.getElementById('tab-inventory').classList.add('border-primary', 'text-gray-900', 'dark:text-white');
    document.getElementById('tab-inventory').classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
  } else if (tabName === 'movements') {
    document.getElementById('tab-content-movements').classList.remove('hidden');
    document.getElementById('tab-movements').classList.add('border-primary', 'text-gray-900', 'dark:text-white');
    document.getElementById('tab-movements').classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    // Recharger les mouvements si nécessaire
    if (currentTechnicianId) {
      loadStockMovements(currentTechnicianId);
    }
  }
}

// Charger les mouvements de stock
let allMovements = [];
async function loadStockMovements(employeeId = null) {
  try {
    // Récupérer tous les équipements
    let query = window.supabase
      .from('employee_equipment')
      .select('*')
      .order('scanned_at', { ascending: false });
    
    // Si un technicien spécifique est sélectionné, filtrer
    if (employeeId) {
      query = query.eq('employee_id', employeeId);
    }
    
    const { data, error } = await query;
    
    if (error) throw error;
    
    // Récupérer les noms des techniciens et dépôts et les prix
    const employeeIds = [...new Set(data.map(item => item.employee_id))];
    const depotIds = [...new Set(data.map(item => item.depot_id).filter(Boolean))];
    
    // Collecter les IDs des articles pour les prix
    const itemIds = new Set();
    data.forEach(item => {
      if (item.inventory_item_id) itemIds.add(item.inventory_item_id);
    });

    // Récupérer les techniciens
    const { data: employees } = await window.supabase
      .from('employees')
      .select('id, first_name, last_name')
      .in('id', employeeIds);
    
    // Récupérer les dépôts
    const { data: depots } = await window.supabase
      .from('depots')
      .select('id, name')
      .in('id', depotIds);
    
    // Créer des maps pour accès rapide
    const employeesMap = {};
    employees?.forEach(emp => {
      employeesMap[emp.id] = emp;
    });
    
    const depotsMap = {};
    depots?.forEach(depot => {
      depotsMap[depot.id] = depot;
    });
    
    // Map pour mapping equipment_id -> inventory_item_id (pour les installations qui n'ont pas item_id)
    const equipIdToInvId = {};
    data.forEach(eq => {
      if (eq.id && eq.inventory_item_id) {
         equipIdToInvId[eq.id] = eq.inventory_item_id;
      }
    });

    // Charger les détails des interventions avec matériaux utilisés
    const { data: interventions, error: interventionsError } = await window.supabase
      .from('intervention_details')
      .select(`
        id,
        materials,
        updated_at,
        technician_id,
        appointments (
          date,
          address,
          npa,
          city,
          client_name
        )
      `)
      .not('materials', 'is', null);

    if (interventionsError) console.error('Erreur chargement interventions:', interventionsError);

    // Ajouter les IDs d'articles des interventions
    if (interventions) {
      interventions.forEach(i => {
        if (i.materials && Array.isArray(i.materials)) {
          i.materials.forEach(m => {
            // Essayer de trouver l'ID de l'article
            let itemId = m.inventory_item_id;
            // Si pas présent, essayer via equipment_id et la map qu'on vient de créer
            if (!itemId && m.equipment_id) {
               itemId = equipIdToInvId[m.equipment_id];
               // On le rajoute à l'objet pour usage ultérieur
               m.inventory_item_id = itemId; 
            }
            if (itemId) itemIds.add(itemId);
          });
        }
      });
    }

    // Récupérer les prix des articles
    const { data: inventoryItems } = await window.supabase
      .from('inventory_items')
      .select('id, price')
      .in('id', [...itemIds]);
    
    const pricesMap = {};
    if (inventoryItems) {
      inventoryItems.forEach(item => {
        pricesMap[item.id] = item.price || 0;
      });
    }

    // Transformer les données en mouvements
    allMovements = [];
    
    // Pour chaque équipement, créer des mouvements (Sorties/Retours)
    data.forEach(item => {
      const employee = employeesMap[item.employee_id];
      const employeeName = employee ? (employee.first_name + ' ' + employee.last_name) : 'Inconnu';
      const depot = depotsMap[item.depot_id];
      const depotName = depot ? depot.name : '-';
      const price = pricesMap[item.inventory_item_id] || 0;
      
      // Adresse du chantier (préparé pour la web app mobile)
      const siteAddress = item.site_address || item.site_location || 'Non renseigné';
      
      // Mouvement de sortie (scanné)
      allMovements.push({
        id: item.id + '_sortie',
        date: item.scanned_at || item.created_at,
        type: 'sortie',
        employee_id: item.employee_id,
        employee_name: employeeName,
        reference: item.reference,
        name: item.name,
        quantity: item.quantity || 1,
        depot_name: depotName,
        site_address: siteAddress,
        equipment_id: item.id,
        price: price
      });
      
      // Mouvement de retour (si retourné)
      if (item.returned && item.returned_at) {
        allMovements.push({
          id: item.id + '_retour',
          date: item.returned_at,
          type: 'retour',
          employee_id: item.employee_id,
          employee_name: employeeName,
          reference: item.reference,
          name: item.name,
          quantity: item.quantity || 1,
          depot_name: depotName,
          site_address: siteAddress,
          equipment_id: item.id,
          price: price
        });
      }
    });

    // Ajouter les mouvements d'installation (depuis interventions)
    if (interventions && interventions.length > 0) {
      interventions.forEach(intervention => {
        if (intervention.materials && Array.isArray(intervention.materials)) {
          const techId = intervention.technician_id;
          const employee = employeesMap[techId];
          const employeeName = employee ? (employee.first_name + ' ' + employee.last_name) : 'Technicien inconnu';
          
          const appt = intervention.appointments;
          let address = 'Chantier';
          if (appt) {
             address = [appt.address, appt.npa, appt.city].filter(Boolean).join(', ') || 'Chantier';
             if (appt.client_name) address += ` (${appt.client_name})`;
          }

          intervention.materials.forEach((mat, index) => {
            const price = mat.inventory_item_id ? (pricesMap[mat.inventory_item_id] || 0) : 0;
            allMovements.push({
              id: `install_${intervention.id}_${index}`,
              date: intervention.updated_at || (appt ? appt.date : new Date().toISOString()),
              type: 'installation', // ou 'utilisation'
              employee_id: techId,
              employee_name: employeeName,
              reference: mat.reference || '-',
              name: mat.name || 'Matériel',
              quantity: mat.quantity || 1,
              depot_name: 'Stock Technicien',
              site_address: address,
              equipment_id: mat.equipment_id || null,
              price: price
            });
          });
        }
      });
    }
    
    // Trier par date (plus récent en premier)
    allMovements.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Afficher les mouvements
    renderMovements(allMovements);
    updateMovementStats(allMovements);
  } catch (error) {
    console.error('Erreur chargement mouvements:', error);
    alert('Erreur lors du chargement des mouvements: ' + error.message);
  }
}

// Afficher les mouvements
function renderMovements(movements) {
  const tbody = document.getElementById('movements-list-body');
  if (!tbody) return;
  tbody.innerHTML = '';
  
  if (movements.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Aucun mouvement trouvé.</td></tr>';
    return;
  }
  
  movements.forEach(movement => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-900/50';
    
    const date = new Date(movement.date).toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    let typeBadge = '';
    if (movement.type === 'sortie') {
      typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">Sortie</span>';
    } else if (movement.type === 'retour') {
      typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">Retour</span>';
    } else if (movement.type === 'installation' || movement.type === 'utilisation') {
      typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">Installé</span>';
    }
    
    tr.innerHTML = 
      '<td class="px-4 py-3 text-sm text-gray-900 dark:text-white">' + date + '</td>' +
      '<td class="px-4 py-3 text-sm">' + typeBadge + '</td>' +
      '<td class="px-4 py-3 text-sm text-gray-900 dark:text-white font-medium">' + movement.employee_name + '</td>' +
      '<td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 font-mono">' + movement.reference + '</td>' +
      '<td class="px-4 py-3 text-sm text-gray-900 dark:text-white">' + movement.name + '</td>' +
      '<td class="px-4 py-3 text-sm text-center text-gray-700 dark:text-gray-300">' + movement.quantity + '</td>' +
      '<td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">' + movement.depot_name + '</td>' +
      '<td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + (movement.site_address || 'Non renseigné') + '</td>';
    
    tbody.appendChild(tr);
  });
}

// Mettre à jour les statistiques des mouvements
function updateMovementStats(movements) {
  // Calculer les sommes des QUANTITÉS (unités) et non le nombre de lignes (produits)
  const sortiesMoves = movements.filter(m => m.type === 'sortie');
  const sorties = sortiesMoves.reduce((acc, m) => acc + (parseInt(m.quantity) || 0), 0);
  
  const retoursMoves = movements.filter(m => m.type === 'retour');
  const retours = retoursMoves.reduce((acc, m) => acc + (parseInt(m.quantity) || 0), 0);
  
  const installationsMoves = movements.filter(m => m.type === 'installation' || m.type === 'utilisation');
  const installations = installationsMoves.reduce((acc, m) => acc + (parseInt(m.quantity) || 0), 0);
  
  // Calculer le Coût Moyen par Chantier (Intervention)
  // On regroupe les installations par ID d'intervention (ou ID de rendez-vous si nécessaire)
  const costPerIntervention = {}; // { intervention_id: total_cost }
  let distinctInterventionsCount = 0;

  installationsMoves.forEach(m => {
    // ID unique de l'intervention : on essaie d'extraire l'ID du mouvement qui est formaté comme "install_{id}_{index}"
    // Ou on peut se baser sur la date/adresse si l'ID n'est pas fiable, mais l'ID est mieux.
    let interventionId = 'unknown';
    if (m.id && m.id.startsWith('install_')) {
      const parts = m.id.split('_');
      if (parts.length >= 2) {
        interventionId = parts[1]; // L'ID de l'intervention
      }
    }
    
    if (!costPerIntervention[interventionId]) {
      costPerIntervention[interventionId] = 0;
      distinctInterventionsCount++;
    }
    
    const qty = parseInt(m.quantity) || 0;
    const price = parseFloat(m.price) || 0;
    costPerIntervention[interventionId] += (qty * price);
  });
  
  // Somme de tous les coûts par chantier
  const totalInstallationCost = Object.values(costPerIntervention).reduce((acc, cost) => acc + cost, 0);
  
  // Moyenne : Coût Total / Nombre d'Interventions distinctes
  // Si on a 0 interventions, moyenne est 0
  const avgCostPerSite = distinctInterventionsCount > 0 ? (totalInstallationCost / distinctInterventionsCount) : 0;
  
  const statSorties = document.getElementById('stat-total-sorties');
  const statRetours = document.getElementById('stat-total-retours');
  const statAvgPrice = document.getElementById('stat-en-circulation'); 
  const statInstallations = document.getElementById('stat-total-installations');
  
  // Mise à jour des labels (au cas où le HTML n'est pas encore mis à jour via l'éditeur)
  const labelAvgPrice = statAvgPrice?.previousElementSibling;
  
  if (statSorties) statSorties.textContent = sorties;
  if (statRetours) statRetours.textContent = retours;
  if (statInstallations) statInstallations.textContent = installations;
  
  if (statAvgPrice) {
    statAvgPrice.textContent = avgCostPerSite.toFixed(2) + ' CHF';
    if(labelAvgPrice) labelAvgPrice.textContent = 'Prix moyen / Install';
  }
}

// Filtrer les mouvements
function filterMovements() {
  const searchTerm = document.getElementById('movement-search')?.value.toLowerCase() || '';
  // Le filtre technicien a été supprimé, on n'utilise que le technicien courant s'il est défini dans loadStockMovements
  const typeFilter = document.getElementById('movement-filter-type')?.value || '';
  
  let filtered = allMovements;
  
  // Note: le filtrage par technicien est déjà fait au chargement via loadStockMovements(currentTechnicianId)
  
  // Filtre par type
  if (typeFilter) {
    filtered = filtered.filter(m => m.type === typeFilter);
  }
  
  // Filtre par recherche
  if (searchTerm) {
    filtered = filtered.filter(m => 
      m.reference.toLowerCase().includes(searchTerm) ||
      m.name.toLowerCase().includes(searchTerm) ||
      m.employee_name.toLowerCase().includes(searchTerm) ||
      m.depot_name.toLowerCase().includes(searchTerm) ||
      (m.site_address && m.site_address.toLowerCase().includes(searchTerm))
    );
  }
  
  renderMovements(filtered);
  updateMovementStats(filtered);
}

// Afficher la liste du matériel
function renderEquipmentList(equipment) {
  const tbody = document.getElementById('equipment-list-body');
  tbody.innerHTML = '';
  
    if (equipment.length === 0) {
    tbody.innerHTML = 
      '<tr>' +
        '<td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">' +
          'Aucun matériel assigné. Le matériel scanné via l\'application mobile apparaîtra ici.' +
        '</td>' +
      '</tr>';
    return;
  }
  
  equipment.forEach(item => {
    const tr = document.createElement('tr');
    tr.className = item.returned ? 'bg-gray-100 dark:bg-gray-800/50 opacity-60' : '';
    
    const scannedDate = item.scanned_at 
      ? new Date(item.scanned_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
      : '-';
    
    const depotName = item.depots?.name || '-';
    
    // Utiliser createElement pour éviter les problèmes de template literals
    const checkedAttr = item.returned ? ' checked' : '';
    const itemId = item.id || '';
    const itemRef = item.reference || '';
    const itemName = item.name || '';
    const itemCat = item.category || '-';
    const itemQty = item.quantity || 1;
    
    tr.innerHTML = 
      '<td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">' +
        '<div class="print-checkbox hidden"></div>' +
        '<input type="checkbox"' + checkedAttr + 
        ' onchange="toggleReturn(\'' + itemId + '\', this.checked)"' +
        ' class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary no-print" />' +
      '</td>' +
      '<td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-gray-900 dark:text-white font-medium">' + itemRef + '</td>' +
      '<td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-gray-700 dark:text-gray-300">' + itemName + '</td>' +
      '<td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-gray-600 dark:text-gray-400">' + itemCat + '</td>' +
      '<td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center text-gray-700 dark:text-gray-300">' + itemQty + '</td>' +
      '<td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-gray-600 dark:text-gray-400">' + depotName + '</td>' +
      '<td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-gray-600 dark:text-gray-400 text-sm">' + scannedDate + '</td>' +
      '<td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-right no-print">' +
        '<button onclick="deleteEquipment(\'' + itemId + '\')" class="text-red-500 hover:text-red-700" title="Supprimer">' +
          '<span class="material-symbols-outlined text-base">delete</span>' +
        '</button>' +
      '</td>';
    tbody.appendChild(tr);
  });
}

// Toggle retour de matériel
async function toggleReturn(equipmentId, returned) {
  if (!window.supabase || typeof window.supabase.from !== 'function') {
    alert('Erreur: Supabase non initialisé');
    return;
  }
  
  try {
    // Récupérer l'équipement pour obtenir les infos de l'article
    const { data: equipment, error: fetchError } = await window.supabase
      .from('employee_equipment')
      .select('inventory_item_id, quantity, returned')
      .eq('id', equipmentId)
      .single();
    
    if (fetchError) throw fetchError;
    if (!equipment) {
      alert('Équipement non trouvé');
      return;
    }
    
    // Récupérer l'article dans l'inventaire
    const { data: inventoryItem, error: itemError } = await window.supabase
      .from('inventory_items')
      .select('quantity')
      .eq('id', equipment.inventory_item_id)
      .single();
    
    if (itemError) throw itemError;
    if (!inventoryItem) {
      alert('Article non trouvé dans l\'inventaire');
      return;
    }
    
    // Mettre à jour le statut de retour
    const updateData = {
      returned: returned,
      returned_at: returned ? new Date().toISOString() : null,
      returned_by: returned ? (await window.supabase.auth.getUser()).data.user?.email || 'admin' : null
    };
    
    const { error: updateError } = await window.supabase
      .from('employee_equipment')
      .update(updateData)
      .eq('id', equipmentId);
    
    if (updateError) throw updateError;
    
    // Mettre à jour le stock dans l'inventaire
    // Si retourné (returned = true) : réincrémenter le stock
    // Si non retourné (returned = false) : décrémenter le stock (annulation du retour)
    const wasReturned = equipment.returned;
    const quantity = equipment.quantity || 1;
    let newStockQuantity;
    
    if (returned && !wasReturned) {
      // Retour du matériel : réincrémenter
      newStockQuantity = inventoryItem.quantity + quantity;
    } else if (!returned && wasReturned) {
      // Annulation du retour : décrémenter à nouveau
      newStockQuantity = Math.max(0, inventoryItem.quantity - quantity);
    } else {
      // Pas de changement de statut, pas besoin de modifier le stock
      newStockQuantity = inventoryItem.quantity;
    }
    
    // Mettre à jour le stock uniquement si nécessaire
    if (returned !== wasReturned) {
      const { error: stockError } = await window.supabase
        .from('inventory_items')
        .update({ quantity: newStockQuantity })
        .eq('id', equipment.inventory_item_id);
      
      if (stockError) {
        console.error('Erreur mise à jour stock:', stockError);
        alert('Statut de retour mis à jour, mais erreur lors de la mise à jour du stock. Veuillez vérifier manuellement.');
      }
    }
    
    // Recharger la liste
    await viewEquipment(currentTechnicianId);
    await loadTechnicians(); // Mettre à jour les stats
  } catch (error) {
    console.error('Erreur toggle retour:', error);
    alert('Erreur lors de la mise à jour: ' + error.message);
  }
}

// Supprimer un équipement
async function deleteEquipment(equipmentId) {
  if (!confirm('Êtes-vous sûr de vouloir supprimer cet équipement de l\'inventaire ?')) {
    return;
  }
  
  if (!window.supabase || typeof window.supabase.from !== 'function') {
    alert('Erreur: Supabase non initialisé');
    return;
  }
  
  try {
    // Récupérer l'équipement avant suppression pour mettre à jour le stock
    const { data: equipment, error: fetchError } = await window.supabase
      .from('employee_equipment')
      .select('inventory_item_id, quantity, returned')
      .eq('id', equipmentId)
      .single();
    
    if (fetchError) throw fetchError;
    
    // Supprimer l'équipement
    const { error: deleteError } = await window.supabase
      .from('employee_equipment')
      .delete()
      .eq('id', equipmentId);
    
    if (deleteError) throw deleteError;
    
    // Si l'équipement n'était pas retourné, réincrémenter le stock
    if (equipment && !equipment.returned) {
      const { data: inventoryItem, error: itemError } = await window.supabase
        .from('inventory_items')
        .select('quantity')
        .eq('id', equipment.inventory_item_id)
        .single();
      
      if (!itemError && inventoryItem) {
        const quantity = equipment.quantity || 1;
        const newStockQuantity = inventoryItem.quantity + quantity;
        
        const { error: stockError } = await window.supabase
          .from('inventory_items')
          .update({ quantity: newStockQuantity })
          .eq('id', equipment.inventory_item_id);
        
        if (stockError) {
          console.error('Erreur mise à jour stock:', stockError);
          alert('Équipement supprimé, mais erreur lors de la mise à jour du stock. Veuillez vérifier manuellement.');
        }
      }
    }
    
    // Recharger la liste
    await viewEquipment(currentTechnicianId);
    await loadTechnicians();
  } catch (error) {
    console.error('Erreur suppression:', error);
    alert('Erreur lors de la suppression: ' + error.message);
  }
}

// Charger les dépôts
async function loadDepots() {
  try {
    const { data, error } = await window.supabase
      .from('depots')
      .select('*')
      .order('name');
    
    if (error) throw error;
    allDepots = data || [];
    
    // Remplir le select
    const select = document.getElementById('add-equipment-depot');
    if (select) {
      select.innerHTML = '<option value="">Sélectionner un dépôt...</option>';
      allDepots.forEach(depot => {
        const option = document.createElement('option');
        option.value = depot.id;
        option.textContent = depot.name;
        select.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Erreur chargement dépôts:', error);
  }
}

// Charger les articles d'inventaire pour un dépôt
async function loadInventoryItems(depotId) {
  if (!depotId) {
    document.getElementById('add-equipment-item').innerHTML = '<option value="">Sélectionner un dépôt d\'abord...</option>';
    return;
  }
  
  try {
    const { data, error } = await window.supabase
      .from('inventory_items')
      .select('*')
      .eq('depot_id', depotId)
      .order('name');
    
    if (error) throw error;
    allInventoryItems = data || [];
    
    // Remplir le select
    const select = document.getElementById('add-equipment-item');
    if (select) {
      select.innerHTML = '<option value="">Sélectionner un article...</option>';
      allInventoryItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = (item.reference || '') + ' - ' + (item.name || '') + ' (Stock: ' + (item.quantity || 0) + ')';
        option.dataset.reference = item.reference || '';
        option.dataset.name = item.name || '';
        option.dataset.category = item.category || 'Outils';
        select.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Erreur chargement articles:', error);
    alert('Erreur lors du chargement des articles: ' + error.message);
  }
}

// Ouvrir le modal d'ajout
async function openAddEquipmentModal() {
  if (!currentTechnicianId) {
    alert('Veuillez sélectionner un technicien');
    return;
  }
  
  await loadDepots();
  document.getElementById('add-equipment-modal').classList.remove('hidden');
  
  // Réinitialiser le formulaire
  document.getElementById('add-equipment-form').reset();
  document.getElementById('add-equipment-item').innerHTML = '<option value="">Sélectionner un dépôt d\'abord...</option>';
}

// Gérer le changement de dépôt
document.getElementById('add-equipment-depot')?.addEventListener('change', (e) => {
  loadInventoryItems(e.target.value);
});

// Ajouter le matériel
document.getElementById('add-equipment-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!window.supabase || typeof window.supabase.from !== 'function') {
    alert('Erreur: Supabase non initialisé');
    return;
  }
  
  const depotId = document.getElementById('add-equipment-depot').value;
  const itemId = document.getElementById('add-equipment-item').value;
  const quantity = parseInt(document.getElementById('add-equipment-quantity').value) || 1;
  
  if (!depotId || !itemId) {
    alert('Veuillez sélectionner un dépôt et un article');
    return;
  }
  
  const selectedItem = allInventoryItems.find(i => i.id === itemId);
  if (!selectedItem) {
    alert('Article non trouvé');
    return;
  }
  
  // Vérifier le stock disponible
  if (selectedItem.quantity < quantity) {
    alert('Stock insuffisant. Stock disponible: ' + selectedItem.quantity);
    return;
  }
  
  try {
    // Récupérer l'utilisateur actuel
    const { data: userData } = await window.supabase.auth.getUser();
    const userEmail = userData?.user?.email || 'admin';
    
    // Créer l'équipement
    const { error: insertError } = await window.supabase
      .from('employee_equipment')
      .insert({
        employee_id: currentTechnicianId,
        inventory_item_id: itemId,
        depot_id: depotId,
        reference: selectedItem.reference,
        name: selectedItem.name,
        category: selectedItem.category || 'Outils',
        quantity: quantity,
        scanned_at: new Date().toISOString(),
        scanned_by: userEmail,
        returned: false
      });
    
    if (insertError) throw insertError;
    
    // Décrémenter le stock dans l'inventaire
    const newQuantity = Math.max(0, selectedItem.quantity - quantity);
    const { error: updateError } = await window.supabase
      .from('inventory_items')
      .update({ quantity: newQuantity })
      .eq('id', itemId);
    
    if (updateError) {
      console.error('Erreur lors de la mise à jour du stock:', updateError);
      // Ne pas bloquer si la mise à jour du stock échoue, mais avertir l'utilisateur
      alert('Matériel ajouté, mais erreur lors de la mise à jour du stock. Veuillez vérifier manuellement.');
    }
    
    // Fermer le modal et recharger
    document.getElementById('add-equipment-modal').classList.add('hidden');
    await viewEquipment(currentTechnicianId);
    await loadTechnicians();
    
    alert('Matériel ajouté avec succès !');
    } catch (error) {
    console.error('Erreur ajout matériel:', error);
    alert('Erreur lors de l\'ajout: ' + error.message);
  }
});

// Fermer le modal d'ajout
document.getElementById('close-add-equipment-modal')?.addEventListener('click', () => {
  document.getElementById('add-equipment-modal').classList.add('hidden');
});

document.getElementById('cancel-add-equipment')?.addEventListener('click', () => {
  document.getElementById('add-equipment-modal').classList.add('hidden');
});

// Imprimer uniquement le contenu du modal
function printEquipmentList() {
  const printContent = document.getElementById('equipment-list-container').innerHTML;
  const techName = document.getElementById('detail-name').textContent || '';
  const techEmail = document.getElementById('detail-email').textContent || '';
  const printDate = 'Date: ' + new Date().toLocaleDateString('fr-FR');
  
  // Échapper les caractères spéciaux pour HTML
  const escapeHtml = function(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  };
  
  const printWindow = window.open('', '_blank');
  if (!printWindow) {
    alert('Veuillez autoriser les popups pour imprimer');
    return;
  }
  
  // Construire le HTML avec concaténation de chaînes
  var htmlContent = '<!DOCTYPE html>';
  htmlContent += '<html>';
  htmlContent += '<head>';
  htmlContent += '<title>Inventaire Matériel - ' + escapeHtml(techName) + '</title>';
  htmlContent += '<style>';
  htmlContent += 'body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; padding: 40px; color: #333; }';
  htmlContent += '.header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #3b82f6; padding-bottom: 20px; }';
  htmlContent += 'h1 { font-size: 24pt; margin: 0; color: #1e3a8a; }';
  htmlContent += '.subtitle { font-size: 14pt; color: #6b7280; margin-top: 5px; }';
  htmlContent += '.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }';
  htmlContent += '.info-item strong { display: block; font-size: 9pt; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }';
  htmlContent += '.info-item span { font-size: 12pt; font-weight: 500; color: #111; }';
  
  htmlContent += 'table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt; background: white; }';
  htmlContent += 'th { background-color: #f3f4f6; color: #374151; font-weight: 600; text-align: left; padding: 12px 8px; border-bottom: 2px solid #e5e7eb; }';
  htmlContent += 'td { padding: 10px 8px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }';
  htmlContent += 'tr:nth-child(even) { background-color: #f9fafb; }';
  
  htmlContent += '.footer { margin-top: 40px; text-align: center; font-size: 9pt; color: #9ca3af; border-top: 1px solid #e5e7eb; padding-top: 20px; }';
  
  // Styles pour masquer les éléments non désirés à l'impression
  htmlContent += '.no-print, button, input[type="checkbox"] { display: none !important; }';
  // Style pour la case à cocher impression
  htmlContent += '.print-checkbox { display: inline-block !important; width: 14px; height: 14px; border: 1px solid #333; margin: 0 auto; }';

  htmlContent += '@media print { body { padding: 0; } .no-print { display: none !important; } }';
  htmlContent += '</style>';
  htmlContent += '</head>';
  htmlContent += '<body>';
  
  htmlContent += '<div class="header">';
  htmlContent += '<h1>Fiche d\'Inventaire</h1>';
  htmlContent += '<div class="subtitle">Matériel et Équipement</div>';
  htmlContent += '</div>';

  htmlContent += '<div class="info-grid">';
  htmlContent += '<div class="info-item"><strong>Technicien</strong><span>' + escapeHtml(techName) + '</span></div>';
  htmlContent += '<div class="info-item"><strong>Email</strong><span>' + escapeHtml(techEmail) + '</span></div>';
  htmlContent += '</div>';

  htmlContent += printContent;
  
  // Section de signature
  htmlContent += '<div style="margin-top: 50px; display: flex; justify-content: space-between;">';
  // Signature Technicien
  htmlContent += '<div style="width: 45%; border-top: 1px solid #333; padding-top: 10px;">';
  htmlContent += '<p style="font-weight: bold; margin-bottom: 40px;">Signature du Technicien</p>';
  htmlContent += '</div>';
  // Signature Chef de Chantier
  htmlContent += '<div style="width: 45%; border-top: 1px solid #333; padding-top: 10px;">';
  htmlContent += '<p style="font-weight: bold; margin-bottom: 40px;">Signature du Chef de Chantier</p>';
  htmlContent += '</div>';
  htmlContent += '</div>';
  
  htmlContent += '<div class="footer">';
  htmlContent += 'Document généré automatiquement via Veloxnumeric - ' + new Date().toLocaleDateString('fr-FR') + ' ' + new Date().toLocaleTimeString('fr-FR');
  htmlContent += '</div>';

  htmlContent += '<script type="text/javascript">';
  htmlContent += 'window.onload = function() { window.print(); };';
  htmlContent += '</' + 'script>';
  htmlContent += '</body>';
  htmlContent += '</html>';
  
  printWindow.document.write(htmlContent);
  printWindow.document.close();
}

// Recherche
document.getElementById('search-input').addEventListener('input', (e) => {
  const term = e.target.value.toLowerCase();
  const filtered = allTechnicians.filter(tech =>
    (tech.first_name && tech.first_name.toLowerCase().includes(term)) ||
    (tech.last_name && tech.last_name.toLowerCase().includes(term)) ||
    (tech.email && tech.email.toLowerCase().includes(term))
  );
  renderTable(filtered);
  updateStats(filtered); // Mettre à jour les KPI avec les données filtrées
});

// Event listeners pour les filtres de mouvements
document.getElementById('movement-search')?.addEventListener('input', filterMovements);
document.getElementById('movement-filter-technician')?.addEventListener('change', filterMovements);
document.getElementById('movement-filter-type')?.addEventListener('change', filterMovements);

// Fermer le modal
document.getElementById('close-detail-modal').addEventListener('click', () => {
  document.getElementById('detail-modal').classList.add('hidden');
});

// Activer le lien actif dans la navbar
function activateNavLink() {
  const currentPage = window.location.pathname.split('/').pop() || 'collaborateurs.html';
  document.querySelectorAll('.nav-link').forEach(link => {
    const href = link.getAttribute('href');
    if (href === currentPage) {
      link.classList.add('bg-primary/10', 'text-primary', 'font-medium');
    } else {
      link.classList.remove('bg-primary/10', 'text-primary', 'font-medium');
    }
  });
}

// Charger le logo
function loadLogo() {
  const logoUrl = localStorage.getItem('company_logo_url') || '';
  const logoElement = document.getElementById('logo');
  if (logoUrl && logoElement) {
    logoElement.src = logoUrl;
    logoElement.style.display = 'block';
  } else if (logoElement) {
    logoElement.style.display = 'none';
  }
}

// Gestion du menu profil
document.getElementById('profile-btn').addEventListener('click', (e) => {
  e.stopPropagation();
  const menu = document.getElementById('profile-menu');
  menu.classList.toggle('hidden');
});

document.addEventListener('click', (e) => {
  const menu = document.getElementById('profile-menu');
  const profileBtn = document.getElementById('profile-btn');
  if (!menu.contains(e.target) && e.target !== profileBtn) {
    menu.classList.add('hidden');
  }
});

// Initialiser
document.addEventListener('DOMContentLoaded', async () => {
  showLoading('Initialisation de Supabase...');
  
  let attempts = 0;
  while ((!window.supabase || typeof window.supabase.from !== 'function') && attempts < 30) {
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
    
    if (typeof window.supabase !== 'undefined' && window.supabase && typeof window.supabase.createClient === 'function' && typeof window.supabase.from !== 'function') {
      if (window.SUPABASE_CONFIG) {
        const SupabaseLib = window.supabase;
        window.supabase = SupabaseLib.createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);
      }
    }
  }
  
  if (window.supabase && typeof window.supabase.from === 'function') {
    console.log('✅ Supabase initialisé avec succès');
    
    // Vérifier l'authentification avant de charger les données
    try {
      const { data: { session }, error: sessionError } = await window.supabase.auth.getSession();
      
      if (sessionError || !session) {
        console.warn('⚠️ Utilisateur non connecté, redirection vers la page de connexion');
        hideLoading();
        alert('Vous devez être connecté pour accéder à cette page.\n\nRedirection vers la page de connexion...');
        // Rediriger vers la page de connexion appropriée
        if (window.location.pathname.includes('/inventaire/')) {
          window.location.href = '../index.html';
        } else {
          window.location.href = 'index.html';
        }
        return;
      }
      
      console.log('✅ Utilisateur authentifié:', session.user.email);
      
      // Afficher le nom de l'utilisateur
      const userNameElement = document.getElementById('user-name');
      const userRoleElement = document.getElementById('user-role');
      const userInitialsElement = document.getElementById('user-initials');
      
      if (userNameElement) {
        // Utiliser l'email ou le nom complet si disponible
        const displayName = session.user.user_metadata?.full_name || 
                            session.user.user_metadata?.name || 
                            session.user.email.split('@')[0];
        userNameElement.textContent = displayName;
        
        // Mettre à jour les initiales
        if (userInitialsElement) {
          const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) || 
                          session.user.email[0].toUpperCase();
          userInitialsElement.textContent = initials;
        }
      }
      
      // Récupérer le rôle de l'utilisateur
      if (userRoleElement && window.supabase) {
        try {
          const { data: roleData } = await window.supabase
            .from('user_roles')
            .select('role')
            .eq('user_id', session.user.id)
            .single();
          
          if (roleData && roleData.role) {
            const roleNames = {
              'admin': 'Administrateur',
              'direction': 'Direction',
              'chef_chantier': 'Chef de chantier',
              'dispatcher': 'Dispatcher',
              'technicien': 'Technicien'
            };
            userRoleElement.textContent = roleNames[roleData.role] || roleData.role;
          }
        } catch (error) {
          console.warn('Erreur lors de la récupération du rôle:', error);
        }
      }

      hideLoading();
      loadLogo();
      activateNavLink();
      await loadDepots();
      await loadTechnicians();
    } catch (authError) {
      console.error('❌ Erreur lors de la vérification de l\'authentification:', authError);
      hideLoading();
      alert('Erreur d\'authentification. Veuillez vous reconnecter.');
      if (window.location.pathname.includes('/inventaire/')) {
        window.location.href = '../index.html';
      } else {
        window.location.href = 'index.html';
      }
    }
  } else {
    console.error('❌ Supabase non chargé');
    hideLoading();
    alert('Erreur: Supabase non chargé. Veuillez recharger la page.');
  }
});
</script>

</body>
</html>
