<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Mat√©riel du Collaborateur - Gestionnaire de Stock</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter%3Awght%40400%3B500%3B700%3B900&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="https://sql.js.org/dist/sql-wasm.js"></script>
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#137fec",
          "background-light": "#f6f7f8",
          "background-dark": "#101922",
        },
        fontFamily: {
          display: ["Inter"],
        },
        borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
      },
    },
  };
</script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<style>
  @media print {
    body {
      background: white !important;
      font-size: 9pt !important;
    }
    .no-print {
      display: none !important;
    }
    .print-content {
      padding: 0;
      max-width: 100%;
    }
    
    /* Optimisation pour recto-verso */
    table {
      font-size: 8pt !important;
      width: 100%;
    }
    
    thead th {
      padding: 4px !important;
      font-size: 8pt !important;
      background: #f3f4f6 !important;
      border: 1px solid #d1d5db !important;
    }
    
    tbody td {
      padding: 3px 4px !important;
      font-size: 8pt !important;
      line-height: 1.2 !important;
      border: 1px solid #e5e7eb !important;
    }
    
    /* En-t√™te compact */
    .print-header {
      margin-bottom: 10px !important;
      padding: 8px !important;
      border: 1px solid #d1d5db !important;
    }
    
    .print-header p {
      font-size: 9pt !important;
      margin: 2px 0 !important;
    }
    
    .print-header .text-2xl {
      font-size: 14pt !important;
    }
    
    /* Signatures compactes */
    .signature-section {
      page-break-inside: avoid;
      margin-top: 15px !important;
      padding: 8px !important;
      border: 1px solid #d1d5db !important;
    }
    
    .signature-section p {
      font-size: 8pt !important;
      margin: 3px 0 !important;
    }
    
    .signature-line {
      border-top: 1px solid #333 !important;
      margin-top: 15px !important;
      padding-top: 3px !important;
    }
    
    /* Notes compactes */
    .notes-section {
      margin-top: 10px !important;
      padding: 8px !important;
      border: 1px solid #d1d5db !important;
      min-height: 60px !important;
    }
    
    .notes-section p {
      font-size: 8pt !important;
      margin-bottom: 5px !important;
    }
  }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">

<div id="loading"></div>

<div id="main-content" style="display: none;" class="flex flex-col min-h-screen">
  <!-- Navigation bar horizontale -->
  <nav class="bg-white dark:bg-background-dark/50 border-b border-gray-200 dark:border-gray-800 no-print">
    <div class="px-6 py-4 flex items-center justify-between">
      <!-- Logo √† gauche -->
      <div class="flex items-center gap-3">
        <img id="logo" src="" alt="Logo" class="h-8 w-auto" style="display:none;" onerror="this.style.display='none'" />
        <span class="text-xl font-bold text-primary">Gestionnaire de Stock</span>
      </div>
      
      <!-- Menu du milieu -->
      <div class="flex items-center gap-1">
        <a href="inventaire.html" class="nav-link px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary dark:hover:bg-primary/20 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined">warehouse</span>
          <span>Inventaire</span>
        </a>
        <a href="collaborateurs.html" class="nav-link px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary dark:hover:bg-primary/20 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined">groups</span>
          <span>Collaborateurs</span>
        </a>
        <a href="vehicule.html" class="nav-link px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary dark:hover:bg-primary/20 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined">directions_car</span>
          <span>V√©hicules</span>
        </a>
        <a href="commandes.html" class="nav-link px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary dark:hover:bg-primary/20 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined">shopping_cart</span>
          <span>Commandes</span>
        </a>
      </div>
      
      <!-- Profil utilisateur √† droite -->
      <div class="flex items-center gap-3 relative">
        <div class="text-right">
          <p class="text-sm font-medium text-gray-900 dark:text-white">Jean-Christophe Normand</p>
          <p class="text-xs text-gray-500 dark:text-gray-400">Administrateur</p>
        </div>
        <div id="profile-btn" class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center text-white font-bold cursor-pointer hover:shadow-lg transition-shadow">
          JCN
        </div>
        
        <!-- Menu d√©roulant -->
        <div id="profile-menu" class="absolute top-full right-0 mt-2 w-48 bg-white dark:bg-background-dark/50 rounded-lg shadow-lg border border-gray-200 dark:border-gray-800 hidden z-50">
          <a href="parametres.html" class="block px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary/10 hover:text-primary dark:hover:bg-primary/20 rounded-t-lg flex items-center gap-2 transition-colors">
            <span class="material-symbols-outlined text-base">settings</span>
            <span>Param√®tres</span>
          </a>
          <div class="border-t border-gray-200 dark:border-gray-700"></div>
          <button class="w-full text-left px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-600 dark:hover:text-red-400 rounded-b-lg flex items-center gap-2 transition-colors">
            <span class="material-symbols-outlined text-base">logout</span>
            <span>D√©connexion</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Contenu principal -->
  <div class="flex-1 p-6 max-w-7xl mx-auto w-full">
    <!-- En-t√™te avec boutons -->
    <div class="mb-8 flex items-center justify-between no-print">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Mat√©riel du collaborateur</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2" id="collaborateur-info">Chargement...</p>
      </div>
      <div class="flex gap-2">
        <button id="print-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition-colors">
          <span class="material-symbols-outlined">print</span>
          <span>Imprimer</span>
        </button>
        <button onclick="window.history.back()" class="bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 dark:hover:bg-gray-600 flex items-center gap-2 transition-colors">
          <span class="material-symbols-outlined">arrow_back</span>
          <span>Retour</span>
        </button>
      </div>
    </div>

    <!-- Zone d'impression -->
    <div id="print-area" class="print-content">
      <!-- En-t√™te du document -->
      <div class="print-header bg-white dark:bg-background-dark/50 rounded-lg p-6 border border-gray-200 dark:border-gray-800 mb-6">
        <div class="grid grid-cols-3 gap-4">
          <div>
            <p class="text-sm text-gray-600 dark:text-gray-400">Collaborateur</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white" id="print-nom">-</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-gray-600 dark:text-gray-400">Date d'impression</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white" id="print-date">-</p>
          </div>
          <div class="text-right">
            <p class="text-sm text-gray-600 dark:text-gray-400">Nombre d'articles</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white" id="article-count">0</p>
          </div>
        </div>
      </div>

      <!-- Tableau du mat√©riel -->
      <div class="bg-white dark:bg-background-dark/50 rounded-lg border border-gray-200 dark:border-gray-800 overflow-hidden mb-6">
        <table class="w-full">
          <thead class="bg-gray-50 dark:bg-background-dark/80 border-b border-gray-200 dark:border-gray-800">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-900 dark:text-white">R√©f.</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-900 dark:text-white">Mat√©riel</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-900 dark:text-white">Cat√©gorie</th>
              <th class="px-3 py-2 text-center text-xs font-semibold text-gray-900 dark:text-white">Qt√©</th>
              <th class="px-3 py-2 text-center text-xs font-semibold text-gray-900 dark:text-white">‚òë</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Aucun mat√©riel assign√©.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Zone de signature et notes -->
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="signature-section bg-white dark:bg-background-dark/50 rounded-lg p-4 border border-gray-200 dark:border-gray-800">
          <p class="text-sm font-semibold text-gray-900 dark:text-white mb-2">‚úÖ Mat√©riel donn√©</p>
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div>
              <p class="text-xs text-gray-600 dark:text-gray-400">Date :</p>
              <div class="border-b border-gray-400 dark:border-gray-500 mt-1 h-6"></div>
            </div>
            <div>
              <p class="text-xs text-gray-600 dark:text-gray-400">Par :</p>
              <div class="border-b border-gray-400 dark:border-gray-500 mt-1 h-6"></div>
            </div>
          </div>
          <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Signature du collaborateur :</p>
          <div class="signature-line h-16"></div>
        </div>
        <div class="signature-section bg-white dark:bg-background-dark/50 rounded-lg p-4 border border-gray-200 dark:border-gray-800">
          <p class="text-sm font-semibold text-gray-900 dark:text-white mb-2">‚Ü©Ô∏è Mat√©riel retourn√©</p>
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div>
              <p class="text-xs text-gray-600 dark:text-gray-400">Date :</p>
              <div class="border-b border-gray-400 dark:border-gray-500 mt-1 h-6"></div>
            </div>
            <div>
              <p class="text-xs text-gray-600 dark:text-gray-400">Par :</p>
              <div class="border-b border-gray-400 dark:border-gray-500 mt-1 h-6"></div>
            </div>
          </div>
          <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Signature du responsable :</p>
          <div class="signature-line h-16"></div>
        </div>
      </div>

      <!-- Zone de notes -->
      <div class="notes-section bg-white dark:bg-background-dark/50 rounded-lg p-4 border border-gray-200 dark:border-gray-800">
        <p class="text-sm font-semibold text-gray-900 dark:text-white mb-2">üìù Notes et commentaires</p>
        <div id="notes-display" class="border border-gray-300 dark:border-gray-600 rounded-lg p-3 min-h-24 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></div>
      </div>
    </div>

    <!-- Bouton ajouter mat√©riel -->
    <div class="mt-8 no-print flex gap-3">
      <button id="add-template-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center gap-2 transition-colors">
        <span class="material-symbols-outlined">checklist</span>
        <span>Ajouter depuis template</span>
      </button>
      <button id="add-materiel-btn" class="bg-primary text-white px-6 py-2 rounded-lg font-semibold hover:bg-primary/90 transition-colors flex items-center gap-2">
        <span class="material-symbols-outlined">add</span>
        <span>Ajouter manuellement</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal pour ajouter du mat√©riel -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden z-40 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-background-dark/90 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-gray-800 p-6">
    <div class="flex items-center justify-between mb-6">
      <h2 id="modal-title" class="text-2xl font-bold text-gray-900 dark:text-white">Ajouter du mat√©riel</h2>
      <button id="close-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <form id="materiel-form" class="space-y-4">
      <input type="hidden" id="materiel-id" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">R√©f√©rence *</label>
          <input type="text" id="reference" required class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mat√©riel *</label>
          <input type="text" id="name" required class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cat√©gorie</label>
          <input type="text" id="category" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quantit√©</label>
          <input type="number" id="quantity" min="1" value="1" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          <input type="checkbox" id="delivered" class="rounded border-gray-300 dark:border-gray-600" />
          <span class="ml-2">Mat√©riel donn√©</span>
        </label>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
        <textarea id="notes" rows="3" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
      </div>
      <div class="flex gap-3 pt-4">
        <button type="submit" class="flex-1 bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary/90">Enregistrer</button>
        <button type="button" id="cancel-btn" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600">Annuler</button>
      </div>
    </form>
  </div>
</div>

<script src="js/database.js"></script>
<script>
let collaborateurId = null;
const TABLE_NAME = 'collaborateur_materiel';

// R√©cup√©rer l'ID du collaborateur depuis l'URL
function getCollaborateurId() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}

async function loadData() {
  const db = getDB();
  if (!db) return;
  
  collaborateurId = getCollaborateurId();
  if (!collaborateurId) {
    alert('Collaborateur non trouv√©');
    window.history.back();
    return;
  }
  
  try {
    // Charger les infos du collaborateur
    const collabResults = db.exec(`SELECT nom, prenom FROM collaborateurs WHERE id = ?`, [collaborateurId]);
    if (collabResults.length > 0) {
      const [nom, prenom] = collabResults[0].values[0];
      const fullName = `${prenom} ${nom}`;
      document.getElementById('collaborateur-info').textContent = fullName;
      document.getElementById('print-nom').textContent = fullName;
    }
    
    // Charger la date actuelle
    const today = new Date().toLocaleDateString('fr-FR');
    document.getElementById('print-date').textContent = today;
    
    // Charger le mat√©riel
    const results = db.exec(`SELECT * FROM ${TABLE_NAME} WHERE collaborateur_id = ? ORDER BY id DESC`, [collaborateurId]);
    const data = results.length > 0 ? results[0].values.map(row => ({
      id: row[0], collaborateur_id: row[1], reference: row[2], name: row[3], 
      category: row[4], quantity: row[5], delivered: row[6], notes: row[7]
    })) : [];
    
    renderTable(data);
  } catch (error) {
    console.error('Erreur:', error);
  }
}

function renderTable(data) {
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';
  
  // Mettre √† jour le compteur d'articles
  document.getElementById('article-count').textContent = data.length;
  
  if (data.length === 0) {
    tbody.innerHTML = `
      <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Aucun mat√©riel assign√©.</td></tr>
    `;
    return;
  }
  
  data.forEach(item => {
    const tr = document.createElement('tr');
    tr.className = 'border-b dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-900/50';
    tr.innerHTML = `
      <td class="px-3 py-2 text-xs font-medium text-gray-900 dark:text-white">${item.reference}</td>
      <td class="px-3 py-2 text-xs">${item.name}</td>
      <td class="px-3 py-2 text-xs">${item.category || '-'}</td>
      <td class="px-3 py-2 text-xs text-center">${item.quantity}</td>
      <td class="px-3 py-2 text-center">
        <input type="checkbox" ${item.delivered ? 'checked' : ''} onchange="updateDelivered(${item.id}, this.checked)" class="w-4 h-4 cursor-pointer" />
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function updateDelivered(id, checked) {
  const db = getDB();
  if (!db) return;
  
  try {
    db.run(`UPDATE ${TABLE_NAME} SET delivered = ? WHERE id = ?`, [checked ? 1 : 0, id]);
    saveDB();
    loadData();
  } catch (error) {
    console.error('Erreur:', error);
  }
}

const modal = document.getElementById('modal');
document.getElementById('add-materiel-btn').addEventListener('click', () => {
  document.getElementById('modal-title').textContent = 'Ajouter du mat√©riel';
  document.getElementById('materiel-form').reset();
  document.getElementById('materiel-id').value = '';
  modal.classList.remove('hidden');
});
document.getElementById('close-modal').addEventListener('click', () => modal.classList.add('hidden'));
document.getElementById('cancel-btn').addEventListener('click', () => modal.classList.add('hidden'));

document.getElementById('materiel-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const db = getDB();
  if (!db) return;
  
  const data = {
    reference: document.getElementById('reference').value.trim(),
    name: document.getElementById('name').value.trim(),
    category: document.getElementById('category').value.trim() || null,
    quantity: parseInt(document.getElementById('quantity').value) || 1,
    delivered: document.getElementById('delivered').checked ? 1 : 0,
    notes: document.getElementById('notes').value.trim() || null,
    id: document.getElementById('materiel-id').value
  };
  
  try {
    if (data.id) {
      db.run(`UPDATE ${TABLE_NAME} SET reference=?, name=?, category=?, quantity=?, delivered=?, notes=? WHERE id=?`,
        [data.reference, data.name, data.category, data.quantity, data.delivered, data.notes, data.id]);
    } else {
      db.run(`INSERT INTO ${TABLE_NAME} (collaborateur_id, reference, name, category, quantity, delivered, notes) VALUES (?,?,?,?,?,?,?)`,
        [collaborateurId, data.reference, data.name, data.category, data.quantity, data.delivered, data.notes]);
    }
    saveDB();
    loadData();
    modal.classList.add('hidden');
  } catch (error) {
    alert('Erreur: ' + error.message);
  }
});

document.getElementById('print-btn').addEventListener('click', () => {
  window.print();
});

document.getElementById('add-template-btn').addEventListener('click', () => {
  window.location.href = `template_materiel.html?id=${collaborateurId}`;
});

// Activer le lien actif dans la navbar
function activateNavLink() {
  const currentPage = window.location.pathname.split('/').pop() || 'materiel_collaborateur.html';
  document.querySelectorAll('.nav-link').forEach(link => {
    const href = link.getAttribute('href');
    if (href === currentPage) {
      link.classList.add('bg-primary/10', 'text-primary', 'font-medium');
    } else {
      link.classList.remove('bg-primary/10', 'text-primary', 'font-medium');
    }
  });
}

// Charger le logo depuis localStorage
function loadLogo() {
  const logoUrl = localStorage.getItem('company_logo_url') || '';
  const logoElement = document.getElementById('logo');
  if (logoUrl && logoElement) {
    logoElement.src = logoUrl;
    logoElement.style.display = 'block';
  } else if (logoElement) {
    logoElement.style.display = 'none';
  }
}

// Gestion du menu profil
const profileBtn = document.getElementById('profile-btn');
const profileMenu = document.getElementById('profile-menu');
if (profileBtn && profileMenu) {
  profileBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    profileMenu.classList.toggle('hidden');
  });

  document.addEventListener('click', (e) => {
    if (!profileMenu.contains(e.target) && e.target !== profileBtn) {
      profileMenu.classList.add('hidden');
    }
  });
}

loadLogo();
activateNavLink();
initDB().then(loadData);
</script>

</body>
</html>
