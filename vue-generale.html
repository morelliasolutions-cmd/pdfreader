<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue g√©n√©rale - Mandats en attente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .copy-btn:hover { transform: scale(1.05); }
        .copy-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="h-full bg-gray-50">
    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Vue g√©n√©rale - Mandats en attente</h1>
                        <p class="text-sm text-gray-500 mt-1">Liste des mandats √† planifier ‚Ä¢ <span id="mandatCount" class="font-semibold">0</span> mandat(s)</p>
                    </div>
                    <button onclick="loadMandats(true)" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                        <span class="material-symbols-outlined text-lg">refresh</span>
                        Actualiser
                    </button>
                </div>
            </div>
        </header>

        <!-- Filters -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center gap-4">
                <label class="text-sm font-medium text-gray-700">Filtrer par canton :</label>
                <select id="cantonFilter" onchange="filterMandats()" class="block w-64 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    <option value="">Tous les cantons</option>
                </select>
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <span class="material-symbols-outlined text-base">info</span>
                    <span id="filteredCount"></span>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="px-6 py-6">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">N¬∞ Mandat</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Client</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Contact</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Adresse</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Canton</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="mandatsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                    <span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span>
                                    <p>Chargement...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast de confirmation -->
    <div id="copyToast" class="hidden fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 transition-opacity z-50">
        <span class="material-symbols-outlined">check_circle</span>
        <span>Num√©ro copi√© dans le presse-papier !</span>
    </div>

    <script>
        // ========== CONFIGURATION CACHE ==========
        const CACHE_KEY = 'mandats_en_attente_cache';
        const CACHE_TTL = 15 * 24 * 60 * 60 * 1000; // 15 jours en millisecondes

        let allMandats = [];
        let filteredMandats = [];

        // ========== GESTION DU CACHE ==========
        
        // R√©cup√©rer les donn√©es du cache
        function getCachedData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) return null;
                
                const { data, timestamp } = JSON.parse(cached);
                const now = Date.now();
                
                // V√©rifier si le cache est toujours valide (moins de 15 jours)
                if (now - timestamp > CACHE_TTL) {
                    console.log('‚è∞ Cache expir√© (> 15 jours), suppression...');
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }
                
                const daysOld = Math.floor((now - timestamp) / (24 * 60 * 60 * 1000));
                console.log('‚úÖ Cache valide (cr√©√© il y a', daysOld, 'jour(s))');
                return data;
            } catch (error) {
                console.error('‚ùå Erreur lecture cache:', error);
                localStorage.removeItem(CACHE_KEY);
                return null;
            }
        }

        // Enregistrer les donn√©es dans le cache
        function setCachedData(data) {
            try {
                const cacheObject = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheObject));
                console.log('üíæ Cache mis √† jour avec', data.length, 'mandats');
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde cache:', error);
            }
        }

        // Au chargement de la page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üîç Initialisation de la vue g√©n√©rale...');
            
            // Attendre que Supabase soit initialis√©
            let attempts = 0;
            while (!window.supabase && attempts < 30) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.supabase) {
                console.error('‚ùå Supabase non initialis√©');
                document.getElementById('mandatsTableBody').innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-500">Erreur de connexion √† la base de donn√©es</td></tr>';
                return;
            }
            
            console.log('‚úÖ Supabase initialis√©');
            await loadMandats();
        });

        // Charger les mandats en attente (avec cache)
        async function loadMandats(forceRefresh = false) {
            try {
                // V√©rifier le cache d'abord (sauf si rafra√Æchissement forc√©)
                if (!forceRefresh) {
                    const cachedData = getCachedData();
                    if (cachedData) {
                        console.log('üì¶ Chargement depuis le cache');
                        allMandats = cachedData;
                        populateFiltersAndRender();
                        return;
                    }
                }

                // Charger depuis Supabase si pas de cache ou rafra√Æchissement forc√©
                console.log('üåê Chargement depuis Supabase...');
                const { data: appointments, error } = await window.supabase
                    .from('appointments')
                    .select('*')
                    .is('date', null)
                    .order('canton', { ascending: true, nullsFirst: false })
                    .order('mandate_number', { ascending: true });
                
                if (error) throw error;
                
                allMandats = appointments || [];
                
                // Sauvegarder dans le cache
                setCachedData(allMandats);
                
                populateFiltersAndRender();
                
                console.log('‚úÖ Charg√©', allMandats.length, 'mandats en attente depuis Supabase');
            } catch (error) {
                console.error('‚ùå Erreur chargement:', error);
                document.getElementById('mandatsTableBody').innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-500">Erreur: ' + error.message + '</td></tr>';
            }
        }

        // Fonction pour remplir les filtres et afficher les mandats
        function populateFiltersAndRender() {
            // Extraire les cantons uniques pour le filtre
            const cantons = [...new Set(allMandats.map(m => m.canton).filter(Boolean))].sort();
            const cantonFilter = document.getElementById('cantonFilter');
            cantonFilter.innerHTML = '<option value="">Tous les cantons</option>';
            cantons.forEach(canton => {
                cantonFilter.innerHTML += `<option value="${canton}">${canton}</option>`;
            });
            
            // Afficher tous les mandats par d√©faut
            filterMandats();
        }

        // Filtrer les mandats par canton
        function filterMandats() {
            const cantonFilter = document.getElementById('cantonFilter').value;
            
            if (cantonFilter) {
                filteredMandats = allMandats.filter(m => m.canton === cantonFilter);
            } else {
                filteredMandats = allMandats;
            }
            
            renderMandats();
        }

        // Afficher les mandats dans le tableau
        function renderMandats() {
            const tbody = document.getElementById('mandatsTableBody');
            
            document.getElementById('mandatCount').textContent = allMandats.length;
            
            if (filteredMandats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">Aucun mandat en attente</td></tr>';
                document.getElementById('filteredCount').textContent = '';
                return;
            }
            
            const cantonFilter = document.getElementById('cantonFilter').value;
            if (cantonFilter) {
                document.getElementById('filteredCount').textContent = `${filteredMandats.length} mandat(s) affich√©(s)`;
            } else {
                document.getElementById('filteredCount').textContent = '';
            }
            
            const rows = filteredMandats.map(mandat => {
                // Contact (t√©l√©phone et/ou email)
                const contactParts = [];
                if (mandat.phone) contactParts.push(`üìû ${mandat.phone}`);
                if (mandat.email) contactParts.push(`‚úâÔ∏è ${mandat.email}`);
                const contact = contactParts.join('<br>') || '<span class="text-gray-400">-</span>';
                
                // Adresse compl√®te
                const addressParts = [];
                if (mandat.address) addressParts.push(mandat.address);
                if (mandat.npa || mandat.city) {
                    addressParts.push(`${mandat.npa || ''} ${mandat.city || ''}`.trim());
                }
                const address = addressParts.join('<br>') || '<span class="text-gray-400">-</span>';
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="font-bold text-gray-900">${mandat.mandate_number || '-'}</span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900">${mandat.client_name || '<span class="text-gray-400">-</span>'}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm text-gray-700">${contact}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm text-gray-700">${address}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            ${mandat.canton ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">${mandat.canton}</span>` : '<span class="text-gray-400">-</span>'}
                        </td>
                        <td class="px-4 py-3 text-center whitespace-nowrap">
                            <button onclick="copyToClipboard('${mandat.mandate_number}')" 
                                    class="copy-btn inline-flex items-center gap-1 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded transition-all">
                                <span class="material-symbols-outlined text-sm">content_copy</span>
                                Copier
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }

        // Copier le num√©ro de mandat dans le presse-papier
        async function copyToClipboard(mandateNumber) {
            try {
                await navigator.clipboard.writeText(mandateNumber);
                showCopyToast();
            } catch (error) {
                console.error('Erreur copie:', error);
                // Fallback pour les navigateurs ne supportant pas clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = mandateNumber;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopyToast();
            }
        }

        // Afficher le toast de confirmation
        function showCopyToast() {
            const toast = document.getElementById('copyToast');
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 2000);
        }
    </script>
</body>
</html>
