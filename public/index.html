<!DOCTYPE html>
<html lang="fr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#137fec"/>
    <link rel="manifest" href="./manifest.json"/>
    <title>ConnectFiber - Gestion chantiers</title>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js" defer></script>
    
    <!-- Config & API -->
    <script src="js/config.js?v=7" defer></script>
    <script src="js/api.js?v=7" defer></script>
    
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" media="print" onload="this.media='all'"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Theme Configuration -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
        /* Fixed overlay form centered in the right half of the screen */
        .fixed-overlay { position: absolute; top: 0; right: 0; bottom: 0; width: 50%; display: flex; align-items: center; justify-content: center; z-index: 30; pointer-events: none; }
        /* Card style matching mobile app: solid background, shadow-xl, no blur */
        .fixed-card { width: 420px; min-width: 420px; background: #ffffff; padding: 40px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); pointer-events: auto; }
        @media (prefers-color-scheme: dark) {
            .fixed-card { background: #111827; }
        }
        .spinner { 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #137fec; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-50 antialiased min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-background-light dark:bg-background-dark z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-slate-600 dark:text-slate-400">Chargement...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="relative flex h-full min-h-screen w-full md:flex-row flex-col bg-background-light dark:bg-background-dark overflow-hidden hidden">
        <!-- Header Image Section - Desktop: Left side, Mobile: Top -->
        <div class="relative w-full md:w-1/2 lg:w-3/5 h-[280px] md:h-screen">
            <!-- Hero Background -->
            <div class="absolute inset-0 bg-cover bg-center" data-alt="Telecommunications technician working on fiber optic cables" style="background-image: url('logo.jpeg');">
            </div>
            <!-- Gradient Overlay for Readability -->
            <div class="absolute inset-0 bg-gradient-to-b md:bg-gradient-to-r from-primary/20 via-transparent to-background-light dark:to-background-dark"></div>
        </div>
        
        <!-- Fixed overlay with form and header (single-column, fixed width) -->
        <div class="fixed-overlay">
            <div class="fixed-card">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white leading-tight mb-2">ConnectFiber</h1>
                    <p class="text-slate-500 dark:text-slate-400 text-base font-normal">Connectez-vous pour accéder à votre espace de gestion.</p>
                </div>
                <!-- Login Form -->
                <form id="loginForm" class="space-y-6 w-full">
                <!-- Email Field -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-900 dark:text-slate-200" for="loginEmail">
                        Email
                    </label>
                    <div class="relative group">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">
                            <span class="material-symbols-outlined text-[20px]">person</span>
                        </div>
                        <input 
                            type="email" 
                            id="loginEmail" 
                            required
                            autocomplete="username"
                            class="w-full h-12 pl-10 pr-4 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm" 
                            placeholder="ex: exemple@agtelecom.ch"
                        />
                    </div>
                </div>
                
                <!-- Password Field -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-900 dark:text-slate-200" for="loginPassword">
                        Mot de passe
                    </label>
                    <div class="relative group">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">
                            <span class="material-symbols-outlined text-[20px]">lock</span>
                        </div>
                        <input 
                            type="password" 
                            id="loginPassword" 
                            required
                            autocomplete="current-password"
                            class="w-full h-12 pl-10 pr-12 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm" 
                            placeholder="Entrez votre mot de passe"
                        />
                        <button 
                            onclick="togglePasswordVisibility()" 
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 focus:outline-none p-1 rounded-md transition-colors" 
                            type="button"
                        >
                            <span id="passwordToggle" class="material-symbols-outlined text-[20px]">visibility_off</span>
                        </button>
                    </div>
                </div>
                
                <!-- Error Message -->
                <div id="loginError" class="hidden p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-700 dark:text-red-300 text-sm font-medium"></div>
                
                <!-- Login Button -->
                <div class="pt-2">
                    <button 
                        type="submit" 
                        class="w-full h-12 bg-primary hover:bg-blue-600 active:scale-[0.98] text-white font-bold rounded-lg shadow-lg shadow-primary/30 transition-all flex items-center justify-center gap-2"
                    >
                        <span>Se connecter</span>
                        <span class="material-symbols-outlined text-[20px]">arrow_forward</span>
                    </button>
                </div>
                <div class="mt-4 text-center">
                    <p class="text-xs text-slate-400">ConnectFiber v2.4.0</p>
                </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div id="mainApp" class="hidden">
        <div class="min-h-screen">
            <div class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex items-center gap-4">
                            <h1 class="text-xl font-bold text-gray-900 dark:text-white">ConnectFiber</h1>
                            <nav class="hidden md:flex space-x-4">
                                <a href="dashboard.html" class="text-primary font-semibold hover:text-red-700">Dashboard</a>
                                <a href="personnel.html" class="text-gray-600 dark:text-gray-300 hover:text-primary">Personnel</a>
                                <a href="pointage.html" class="text-gray-600 dark:text-gray-300 hover:text-primary">Pointage</a>
                                <a href="production.html" class="text-gray-600 dark:text-gray-300 hover:text-primary">Production</a>
                                <a href="planning.html" class="text-gray-600 dark:text-gray-300 hover:text-primary">Planning</a>
                                <a href="parametres.html" class="text-gray-600 dark:text-gray-300 hover:text-primary">Paramètres</a>
                            </nav>
                        </div>
                        <div class="flex items-center gap-4">
                            <span id="userName" class="text-sm font-semibold text-gray-700 dark:text-gray-300"></span>
                            <button onclick="logout()" class="text-sm text-red-600 hover:text-red-700 font-semibold">Déconnexion</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="text-center py-20">
                    <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">dashboard</span>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Bienvenue sur ConnectFiber</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-8">Choisissez une page dans le menu ci-dessus</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-4xl mx-auto">
                        <a href="dashboard.html" class="block p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-gray-200 dark:border-gray-700">
                            <span class="material-symbols-outlined text-4xl text-primary mb-2">dashboard</span>
                            <h3 class="font-bold text-gray-900 dark:text-white">Dashboard</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Vue d'ensemble</p>
                        </a>
                        <a href="personnel.html" class="block p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-gray-200 dark:border-gray-700">
                            <span class="material-symbols-outlined text-4xl text-primary mb-2">group</span>
                            <h3 class="font-bold text-gray-900 dark:text-white">Personnel</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Gestion employés</p>
                        </a>
                        <a href="pointage.html" class="block p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-gray-200 dark:border-gray-700">
                            <span class="material-symbols-outlined text-4xl text-primary mb-2">schedule</span>
                            <h3 class="font-bold text-gray-900 dark:text-white">Pointage</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Saisie heures</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // currentUser est déjà déclaré dans role-access-control.js
        // let currentUser = null; // Supprimé pour éviter la duplication
        let isChecking = false; // Empêcher les vérifications multiples

        // Au chargement
        document.addEventListener('DOMContentLoaded', async () => {
            if (isChecking) return;
            isChecking = true;
            
            console.log('Index - Vérification session...');
            
            // Attendre que l'API soit prête
            if (!window.VeloxAPI) {
                console.log('API pas encore chargée, attente...');
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            try {
                const session = await window.VeloxAPI.getSession();
                console.log('Session:', session);
                if (session && session.user) {
                    currentUser = session.user;
                    console.log('✅ Utilisateur déjà connecté, redirection...');
                    // Redirect to dashboard
                    window.location.replace('dashboard.html'); // Use replace to avoid back button loop
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                console.error('Erreur init:', error);
                // Si erreur de connexion, afficher un message d'avertissement
                if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED'))) {
                    console.warn('⚠️ Supabase non accessible. Vérifiez la configuration dans js/config.js');
                }
                showLoginScreen();
            }
        });

                // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            try {
                errorEl.classList.add('hidden');
                
                // Désactiver le bouton pendant la connexion
                if (submitButton) {
                    submitButton.disabled = true;
                    const originalContent = submitButton.innerHTML;
                    submitButton.innerHTML = '<span class="animate-spin">⏳</span> Connexion...';
                    
                    try {
                        console.log('Tentative de connexion...');
                        const data = await window.VeloxAPI.signIn(email, password);
                        console.log('Connexion réussie:', data);
                        currentUser = data.user;
                        console.log('✅ Redirection vers dashboard...');
                        // Redirect to dashboard
                        window.location.replace('dashboard.html'); // Use replace to avoid back button loop
                    } finally {
                        // Réactiver le bouton en cas d'erreur
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalContent;
                    }
                } else {
                    const data = await window.VeloxAPI.signIn(email, password);
                    console.log('Connexion réussie:', data);
                    currentUser = data.user;
                    window.location.replace('dashboard.html');
                }
            } catch (error) {
                console.error('Erreur login:', error);
                
                // Messages d'erreur plus clairs
                let errorMessage = 'Email ou mot de passe incorrect';
                
                if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED'))) {
                    errorMessage = '❌ Serveur Supabase non accessible.\n\nVérifiez que Supabase est démarré sur le serveur ou contactez l\'administrateur système.\n\nURL configurée: http://78.47.97.137:8000';
                } else if (error.message && error.message.includes('Tracking Prevention')) {
                    errorMessage = '⚠️ Blocage par le navigateur. Désactivez le Tracking Prevention ou utilisez un autre navigateur.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
            }
        });

        // Logout
        async function logout() {
            try {
                await window.VeloxAPI.signOut();
                currentUser = null;
                location.reload();
            } catch (error) {
                console.error('Erreur logout:', error);
            }
        }

        function showLoginScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('loginPassword');
            const icon = document.getElementById('passwordToggle');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.textContent = 'visibility';
            } else {
                passwordInput.type = 'password';
                icon.textContent = 'visibility_off';
            }
        }

        // Register Service Worker (cache 74h)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .catch(() => {});
            });
        }
    </script>
</body>
</html>

