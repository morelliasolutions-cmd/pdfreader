<!DOCTYPE html>

<html class="light" lang="fr"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta name="theme-color" content="#F59E0B"/>
<link rel="manifest" href="./manifest.json"/>
<title>Connexion Chef de Chantier</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js" defer></script>
<script src="../../js/config.js?v=7" defer></script>
<script src="../../js/api.js?v=7" defer></script>
<!-- Material Symbols -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" media="print" onload="this.media='all'"/>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<!-- Theme Configuration -->
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-50 antialiased min-h-screen flex justify-center">
<!-- Mobile Viewport Container -->
<div class="relative flex h-full min-h-screen w-full max-w-[480px] flex-col bg-background-light dark:bg-background-dark shadow-xl overflow-hidden">
<!-- Header Image Section -->
<div class="relative w-full h-[280px]">
<!-- Hero Background -->
<div class="absolute inset-0 bg-cover bg-center" data-alt="Telecommunications technician working on fiber optic cables" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuBtLhnG8nuYJOEf1B66bfpB1W1f4O7ZftRCZ2vCUJp04S7ux6TccqPpUKDZnHspEingl5koepjxMKDz0mWIevecMChDjTvU_EBZaubPJp0m6XFK_HKjet25unm1rgY59XJbKu1pUeSify5IInsPQmWUDdYdD8h9gDtg833RsN55pkjPbJkRCCjonVC6v3HH4OBT_tqPAQXHy8-_Jxn-0Ga3lFfJrQ5gzZAx9deWcojzhDkKQ25Mt20ofEtHGkKWAmFN66uabNYEQRwo');">
</div>
<!-- Gradient Overlay for Readability -->
<div class="absolute inset-0 bg-gradient-to-b from-primary/20 via-transparent to-background-light dark:to-background-dark"></div>
<!-- Subtle Top Bar - Supprimé -->
</div>
<!-- Main Content Area -->
<div class="flex-1 px-6 -mt-12 relative z-10">
<!-- Header Text -->
<div class="mb-8">
<h1 class="text-3xl font-bold text-slate-900 dark:text-white leading-tight mb-2">ConnectFiber</h1>
<p class="text-slate-500 dark:text-slate-400 text-base font-normal">Connectez-vous pour accéder à vos interventions et au planning.</p>
</div>
<!-- Login Form -->
<form class="space-y-6" onsubmit="handleLogin(event); return false;">
<!-- Username Field -->
<div class="space-y-2">
<label class="block text-sm font-medium text-slate-900 dark:text-slate-200" for="email">
                        Email
                    </label>
<div class="relative group">
<div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">
<span class="material-symbols-outlined text-[20px]">person</span>
</div>
<input autocomplete="username" class="w-full h-12 pl-10 pr-4 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm" id="email" name="email" placeholder="ex: chef@morellia.ch" type="email"/>
</div>
</div>
<!-- Password Field -->
<div class="space-y-2">
<div class="flex justify-between items-center">
<label class="block text-sm font-medium text-slate-900 dark:text-slate-200" for="password">
                            Mot de passe
                        </label>
</div>
<div class="relative group">
<div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">
<span class="material-symbols-outlined text-[20px]">lock</span>
</div>
<input autocomplete="current-password" class="w-full h-12 pl-10 pr-12 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm" id="password" name="password" placeholder="Entrez votre mot de passe" type="password"/>
<button onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 focus:outline-none p-1 rounded-md transition-colors" type="button">
<span id="passwordToggle" class="material-symbols-outlined text-[20px]">visibility_off</span>
</button>
</div>
</div>
<!-- Login Button -->
<div class="pt-2">
<button class="w-full h-12 bg-primary hover:bg-blue-600 active:scale-[0.98] text-white font-bold rounded-lg shadow-lg shadow-primary/30 transition-all flex items-center justify-center gap-2" type="submit">
<span>Se connecter</span>
<span class="material-symbols-outlined text-[20px]">arrow_forward</span>
</button>
</div>
</form>
</div>
<!-- Footer / Support -->
<div class="mt-auto py-6 px-6 text-center">
<p class="text-xs text-slate-400 dark:text-slate-500 mb-2">ConnectFiber v2.4.0</p>
<a class="inline-flex items-center gap-1.5 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors" href="#">
<span class="material-symbols-outlined text-[18px]">headset_mic</span>
                Contacter le support IT
            </a>
        </div>
    </div>
<script>
// Vérifier si l'utilisateur est déjà connecté
document.addEventListener('DOMContentLoaded', async function() {
    // Attendre que Supabase soit initialisé
    let attempts = 0;
    while ((!window.supabase || typeof window.supabase.auth === 'undefined') && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }
    
    if (window.supabase && window.supabase.auth) {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (user) {
            // Vérifier le rôle
            const { data: roleData } = await window.supabase
                .from('user_roles')
                .select('role')
                .eq('user_id', user.id)
                .single();
            
            if (roleData && (roleData.role === 'chef de chantier' || roleData.role === 'admin')) {
                window.location.href = 'chefintervention.html';
            }
        }
    }
});

// Fonction de connexion
async function handleLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const loginButton = event.target.querySelector('button[type="submit"]');
    const errorDiv = document.getElementById('error-message');
    
        // Afficher un état de chargement
        if (loginButton) {
            loginButton.disabled = true;
            loginButton.innerHTML = '<span class="animate-spin">⏳</span> Connexion en cours...';
        }
    
    // Masquer les erreurs précédentes
    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
    
    try {
        // Attendre que Supabase soit initialisé
        let attempts = 0;
        while ((!window.supabase || typeof window.supabase.auth === 'undefined') && attempts < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }
        
        if (!window.supabase || !window.supabase.auth) {
            throw new Error('Supabase non initialisé');
        }
        
        // Connexion
        const { data, error } = await window.supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) {
            throw error;
        }
        
        // Vérifier le rôle de l'utilisateur
        const { data: roleData, error: roleError } = await window.supabase
            .from('user_roles')
            .select('role')
            .eq('user_id', data.user.id)
            .single();
        
        if (roleError || !roleData) {
            // Déconnexion si pas de rôle
            await window.supabase.auth.signOut();
            throw new Error('Aucun rôle attribué. Contactez un administrateur.');
        }
        
        const role = roleData.role;
        
        // Vérifier que c'est un chef de chantier ou admin
        if (role !== 'chef de chantier' && role !== 'admin') {
            await window.supabase.auth.signOut();
            throw new Error('Accès réservé aux chefs de chantier et administrateurs.');
        }
        
        // Redirection vers chefintervention.html
        window.location.href = 'chefintervention.html';
        
    } catch (error) {
        console.error('Erreur de connexion:', error);
        
        // Afficher l'erreur
        let errorMsg = document.getElementById('error-message');
        if (!errorMsg) {
            errorMsg = document.createElement('div');
            errorMsg.id = 'error-message';
            errorMsg.className = 'mt-4 p-3 bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700 rounded-lg text-red-700 dark:text-red-400 text-sm';
            event.target.appendChild(errorMsg);
        }
        
        errorMsg.textContent = error.message || 'Erreur de connexion. Vérifiez vos identifiants.';
        errorMsg.style.display = 'block';
        
        // Réactiver le bouton
        if (loginButton) {
            loginButton.disabled = false;
            loginButton.innerHTML = '<span>Se connecter</span><span class="material-symbols-outlined text-[20px]">arrow_forward</span>';
        }
    }
}

// Toggle password visibility
function togglePasswordVisibility() {
    const passwordInput = document.getElementById('password');
    const icon = document.getElementById('passwordToggle');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.textContent = 'visibility';
    } else {
        passwordInput.type = 'password';
        icon.textContent = 'visibility_off';
    }
}

// Register Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker registration failed'));
    });
}
</script>
</body></html>