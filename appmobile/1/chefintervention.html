<!DOCTYPE html>
<html class="light" lang="fr"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta name="theme-color" content="#F59E0B"/>
<link rel="manifest" href="./manifest.json"/>
<title>V√©rification des Interventions</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" media="print" onload="this.media='all'"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js" defer></script>
<script src="../../js/config.js?v=7" defer></script>
<script src="../../js/api.js?v=7" defer></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1c2433",
                        "text-main-light": "#111318",
                        "text-main-dark": "#e2e8f0",
                        "text-sub-light": "#616f89",
                        "text-sub-dark": "#94a3b8",
                        "border-light": "#e2e8f0",
                        "border-dark": "#2d3748"
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.375rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px" },
                },
            },
        }
    </script>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="font-display bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark antialiased selection:bg-primary selection:text-white">
<div class="relative flex h-full min-h-screen w-full flex-col max-w-md mx-auto bg-background-light dark:bg-background-dark shadow-xl overflow-hidden">
<!-- Header -->
<header class="sticky top-0 z-10 bg-surface-light/95 dark:bg-surface-dark/95 backdrop-blur-md border-b border-border-light dark:border-border-dark px-4 pt-12 pb-4 shadow-sm">
<div class="flex items-center justify-between mb-4">
<button onclick="handleLogout()" class="p-2 rounded-full hover:bg-background-light dark:hover:bg-background-dark text-text-main-light dark:text-text-main-dark transition-colors" title="D√©connexion">
<span class="material-symbols-outlined">logout</span>
</button>
<h1 class="text-lg font-bold tracking-tight">Interventions</h1>
<div class="w-10"></div>
</div>
<!-- Date Selector -->
<div class="flex items-center justify-between bg-background-light dark:bg-background-dark rounded-xl p-3">
<button onclick="changeDate(-1)" class="p-2 rounded-full hover:bg-surface-light dark:hover:bg-surface-dark text-text-main-light dark:text-text-main-dark transition-colors" title="Jour pr√©c√©dent">
<span class="material-symbols-outlined">chevron_left</span>
</button>
<div class="flex flex-col items-center flex-1">
<span id="date-label" class="text-xs font-semibold text-primary uppercase tracking-wider">Aujourd'hui</span>
<span id="date-display" class="text-sm font-bold text-text-main-light dark:text-text-main-dark">Chargement...</span>
</div>
<button onclick="changeDate(1)" class="p-2 rounded-full hover:bg-surface-light dark:hover:bg-surface-dark text-text-main-light dark:text-text-main-dark transition-colors" title="Jour suivant">
<span class="material-symbols-outlined">chevron_right</span>
</button>
</div>
</header>
<!-- Main Content -->
<main class="flex-1 overflow-y-auto pb-32 px-4 pt-6">
<!-- Interventions List -->
<div id="interventions-list" class="space-y-4">
<div class="text-center py-8 text-text-sub-light dark:text-text-sub-dark">
<span class="material-symbols-outlined text-4xl mb-2 opacity-50">schedule</span>
<p>Chargement des interventions...</p>
</div>
</div>
</main>
<!-- Bottom Navigation -->
<nav class="fixed bottom-0 w-full max-w-md bg-surface-light dark:bg-surface-dark border-t border-border-light dark:border-border-dark pb-safe pt-2 px-2 z-30 pb-4">
<div class="grid grid-cols-4 gap-1">
<a href="carte-interventions.html" class="flex flex-col items-center justify-center p-2 rounded-xl text-text-sub-light dark:text-text-sub-dark hover:bg-background-light dark:hover:bg-background-dark/50 transition-colors">
<span class="material-symbols-outlined">map</span>
<span class="text-[10px] font-medium mt-1">Carte</span>
</a>
<button class="flex flex-col items-center justify-center p-2 rounded-xl text-primary bg-primary/10">
<span class="material-symbols-outlined filled">engineering</span>
<span class="text-[10px] font-medium mt-1">Interventions</span>
</button>
<a href="verification-inventaire.html" class="flex flex-col items-center justify-center p-2 rounded-xl text-text-sub-light dark:text-text-sub-dark hover:bg-background-light dark:hover:bg-background-dark/50 transition-colors">
<span class="material-symbols-outlined">inventory_2</span>
<span class="text-[10px] font-medium mt-1">Stock</span>
</a>
<a href="on-hold.html" class="flex flex-col items-center justify-center p-2 rounded-xl text-text-sub-light dark:text-text-sub-dark hover:bg-background-light dark:hover:bg-background-dark/50 transition-colors">
<span class="material-symbols-outlined">report_problem</span>
<span class="text-[10px] font-medium mt-1">On Hold</span>
</a>
</div>
</nav>
</div>

<script>
// ===== STATE =====
let currentDate = new Date();
let currentUserRole = null;
let currentUserId = null;
let canEdit = false; // Permet de savoir si l'utilisateur peut modifier

// Restaurer la derni√®re date consult√©e
const savedDate = localStorage.getItem('chef_last_viewed_date');
if (savedDate) {
    currentDate = new Date(savedDate);
}

// ===== CACHE SYSTEM =====
const CACHE_PREFIX = 'chef_chantier_';
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

// Sauvegarder dans le cache
function saveToCache(key, data) {
    try {
        const cacheData = {
            data: data,
            timestamp: Date.now()
        };
        localStorage.setItem(CACHE_PREFIX + key, JSON.stringify(cacheData));
    } catch (error) {
        console.error('Erreur sauvegarde cache:', error);
    }
}

// Charger depuis le cache
function loadFromCache(key) {
    try {
        const cached = localStorage.getItem(CACHE_PREFIX + key);
        if (!cached) return null;
        
        const cacheData = JSON.parse(cached);
        const age = Date.now() - cacheData.timestamp;
        
        // V√©rifier si le cache est encore valide (moins de 5 minutes)
        if (age < CACHE_DURATION) {
            return cacheData.data;
        } else {
            // Cache expir√©, le supprimer
            localStorage.removeItem(CACHE_PREFIX + key);
            console.log('Cache expir√© pour:', key);
            return null;
        }
    } catch (error) {
        console.error('Erreur chargement cache:', error);
        return null;
    }
}

// Obtenir la cl√© de cache pour une date
function getCacheKey(date) {
    const dateStr = date.toISOString().split('T')[0];
    return `interventions_${dateStr}`;
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', async function() {
    await initializeApp();
    // Charger d'abord depuis le cache (instantan√©)
    loadInterventionsFromCache();
    // Puis charger depuis Supabase et mettre √† jour
    await loadInterventions();
});

// ===== INITIALIZATION =====
async function initializeApp() {
    // Attendre que la biblioth√®que Supabase soit charg√©e
    let libAttempts = 0;
    while ((typeof window.supabase === 'undefined' || typeof window.supabase.createClient === 'undefined') && libAttempts < 30) {
        await new Promise(resolve => setTimeout(resolve, 100));
        libAttempts++;
    }
    
    // Si config.js n'a pas encore initialis√©, appeler initSupabase manuellement
    if (window.supabase && typeof window.supabase.createClient === 'function' && typeof window.supabase.auth === 'undefined') {
        // La biblioth√®que est l√† mais pas encore initialis√©e comme client
        if (typeof initSupabase === 'function') {
            initSupabase();
        } else {
            // Initialiser manuellement si initSupabase n'est pas disponible
            const SupabaseLib = window.supabase;
            const SUPABASE_URL = 'https://wdurkaelytgjbcsmkzgb.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkdXJrYWVseXRnamJjc21remdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3ODc0NDksImV4cCI6MjA4MjM2MzQ0OX0.E7R_3Ylk1Tf8FJurHfzhb-QgHokeVORpk99_nukjYZY';
            window.supabase = SupabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
    }
    
    // Attendre que le client Supabase soit compl√®tement initialis√©
    let attempts = 0;
    while ((!window.supabase || typeof window.supabase.auth === 'undefined' || typeof window.supabase.from === 'undefined') && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }
    
    if (!window.supabase || typeof window.supabase.auth === 'undefined' || typeof window.supabase.from === 'undefined') {
        console.error('Supabase non initialis√© apr√®s', attempts, 'tentatives');
        console.error('window.supabase:', window.supabase);
        alert('Erreur de connexion. Veuillez recharger la page.');
        return;
    }
    
    // V√©rifier l'authentification
    const { data: { user }, error: authError } = await window.supabase.auth.getUser();
    
    if (authError || !user) {
        window.location.href = 'index.html';
        return;
    }
    
    currentUserId = user.id;
    
    // R√©cup√©rer le r√¥le de l'utilisateur
    const { data: roleData, error: roleError } = await window.supabase
        .from('user_roles')
        .select('role')
        .eq('user_id', user.id)
        .single();
    
    if (roleError || !roleData) {
        console.error('R√¥le non trouv√©');
        window.location.href = 'index.html';
        return;
    }
    
    currentUserRole = roleData.role;
    
    // V√©rifier les permissions
    if (currentUserRole === 'admin' || currentUserRole === 'chef_chantier') {
        canEdit = true;
    } else if (currentUserRole === 'dispatcher') {
        canEdit = false; // Lecture seule
    } else {
        // Technicien ou autre r√¥le non autoris√©
        window.location.href = 'index.html';
        return;
    }
    
    updateDateDisplay();
}

// ===== DATE MANAGEMENT =====
function changeDate(delta) {
    currentDate.setDate(currentDate.getDate() + delta);
    // Sauvegarder la date consult√©e
    localStorage.setItem('chef_last_viewed_date', currentDate.toISOString());
    updateDateDisplay();
    // Charger d'abord depuis le cache (instantan√©)
    loadInterventionsFromCache();
    // Puis charger depuis Supabase et mettre √† jour
    loadInterventions();
}

function updateDateDisplay() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const selectedDate = new Date(currentDate);
    selectedDate.setHours(0, 0, 0, 0);
    
    const dateLabel = document.getElementById('date-label');
    const dateDisplay = document.getElementById('date-display');
    
    if (selectedDate.getTime() === today.getTime()) {
        dateLabel.textContent = "Aujourd'hui";
    } else if (selectedDate.getTime() === today.getTime() - 86400000) {
        dateLabel.textContent = "Hier";
    } else if (selectedDate.getTime() === today.getTime() + 86400000) {
        dateLabel.textContent = "Demain";
    } else {
        dateLabel.textContent = selectedDate.toLocaleDateString('fr-FR', { weekday: 'long' });
    }
    
    dateDisplay.textContent = currentDate.toLocaleDateString('fr-FR', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
    });
}

// ===== LOAD INTERVENTIONS FROM CACHE (INSTANTAN√â) =====
function loadInterventionsFromCache() {
    const cacheKey = getCacheKey(currentDate);
    const cachedData = loadFromCache(cacheKey);
    
    if (cachedData && cachedData.interventions) {
        console.log('Affichage des donn√©es en cache (instantan√©)');
        renderInterventions(
            cachedData.interventions, 
            cachedData.validationMap || {}, 
            cachedData.employeesMap || {}, 
            cachedData.appointmentsMap || {}
        );
    } else {
        // Pas de cache, afficher le message de chargement
        const container = document.getElementById('interventions-list');
        container.innerHTML = '<div class="text-center py-8 text-text-sub-light dark:text-text-sub-dark"><span class="material-symbols-outlined text-4xl mb-2 opacity-50">schedule</span><p>Chargement...</p></div>';
    }
}

// ===== LOAD INTERVENTIONS FROM SUPABASE (OPTIMIS√â) =====
async function loadInterventions() {
    if (!window.supabase) {
        loadInterventionsFromCache();
        return;
    }
    
    const container = document.getElementById('interventions-list');
    const cacheKey = getCacheKey(currentDate);
    const cachedData = loadFromCache(cacheKey);
    
    // üöÄ Afficher le cache imm√©diatement
    if (cachedData) {
        renderInterventions(cachedData.interventions, cachedData.validationMap, cachedData.employeesMap, cachedData.appointmentsMap);
    } else {
        container.innerHTML = '<div class="text-center py-8 text-text-sub-light dark:text-text-sub-dark"><span class="material-symbols-outlined text-4xl mb-2 opacity-50">schedule</span><p>Chargement...</p></div>';
    }
    
    try {
        const dateStr = currentDate.toISOString().split('T')[0];
        
        // üöÄ OPTIMISATION 1: Parall√©liser appointments et interventions avec limites
        const [appointmentsResult, interventionsResult] = await Promise.all([
            window.supabase
                .from('appointments')
                .select('id, date, start_time, mandate_number, employee_id, address')
                .eq('date', dateStr)
                .order('start_time', { ascending: true })
                .limit(100),
            
            window.supabase
                .from('intervention_details')
                .select('id, appointment_id, mandate_number, status, created_at, technician_id, client_name, address')
                .gte('created_at', dateStr + 'T00:00:00')
                .lte('created_at', dateStr + 'T23:59:59')
                .order('created_at', { ascending: false })
                .limit(100)
        ]);
        
        const { data: appointments, error: appointmentsError } = appointmentsResult;
        const { data: allInterventions, error: interventionsError } = interventionsResult;
        
        if (appointmentsError || interventionsError) {
            console.error('Erreur:', appointmentsError || interventionsError);
            if (!cachedData) container.innerHTML = '<div class="text-center py-8 text-red-500"><p>Erreur lors du chargement</p></div>';
            return;
        }
        
        if (!appointments || appointments.length === 0) {
            const emptyCache = { interventions: [], validationMap: {}, employeesMap: {}, appointmentsMap: {} };
            saveToCache(cacheKey, emptyCache);
            container.innerHTML = '<div class="text-center py-8 text-text-sub-light dark:text-text-sub-dark"><span class="material-symbols-outlined text-4xl mb-2 opacity-50">inventory_2</span><p>Aucune intervention</p></div>';
            return;
        }
        
        // üöÄ OPTIMISATION 2: Cr√©er maps et filtrer en une passe
        const appointmentsMap = Object.fromEntries(appointments.map(a => [a.id, a]));
        const appointmentIds = new Set(appointments.map(a => a.id));
        const interventions = (allInterventions || []).filter(i => appointmentIds.has(i.appointment_id));
        
        if (interventions.length === 0) {
            const emptyCache = { interventions: [], validationMap: {}, employeesMap: {}, appointmentsMap };
            saveToCache(cacheKey, emptyCache);
            container.innerHTML = '<div class="text-center py-8 text-text-sub-light dark:text-text-sub-dark"><span class="material-symbols-outlined text-4xl mb-2 opacity-50">inventory_2</span><p>Aucune intervention valid√©e</p></div>';
            return;
        }
        
        // üöÄ OPTIMISATION 3: D√©dupliquer en une passe avec Map
        const uniqueInterventionsMap = new Map();
        interventions.forEach(i => {
            if (i.appointment_id && !uniqueInterventionsMap.has(i.appointment_id)) {
                uniqueInterventionsMap.set(i.appointment_id, i);
            }
        });
        const uniqueInterventions = Array.from(uniqueInterventionsMap.values());
        
        // üöÄ OPTIMISATION 4: Charger employees, photos et validations en parall√®le
        const employeeIds = [...new Set([
            ...uniqueInterventions.map(i => i.technician_id).filter(Boolean),
            ...appointments.map(a => a.employee_id).filter(Boolean)
        ])];
        
        const interventionIds = uniqueInterventions.map(i => i.id);
        
        const [employeesResult, photosResult] = await Promise.all([
            employeeIds.length > 0 
                ? window.supabase.from('employees').select('id, first_name, last_name, photo_url').in('id', employeeIds)
                : { data: [] },
            interventionIds.length > 0
                ? window.supabase.from('intervention_photos').select('id, intervention_detail_id').in('intervention_detail_id', interventionIds)
                : { data: [] }
        ]);
        
        const { data: employees } = employeesResult;
        const { data: photos } = photosResult;
        
        // Charger validations seulement si photos existent
        let photoValidations = [];
        if (photos && photos.length > 0) {
            const photoIds = photos.map(p => p.id);
            const { data: validations } = await window.supabase
                .from('photo_ai_validations')
                .select('photo_id, validation_status')
                .in('photo_id', photoIds);
            photoValidations = validations || [];
        }
        
        // üöÄ OPTIMISATION 5: Cr√©er maps efficacement
        const employeesMap = Object.fromEntries((employees || []).map(e => [e.id, e]));
        
        const validationMap = {};
        (photos || []).forEach(photo => {
            const validation = photoValidations.find(v => v.photo_id === photo.id);
            if (validation) {
                if (!validationMap[photo.intervention_detail_id]) {
                    validationMap[photo.intervention_detail_id] = [];
                }
                validationMap[photo.intervention_detail_id].push(validation);
            }
        });
        
        // Sauvegarder et afficher
        const freshCache = { interventions: uniqueInterventions, validationMap, employeesMap, appointmentsMap };
        saveToCache(cacheKey, freshCache);
        renderInterventions(uniqueInterventions, validationMap, employeesMap, appointmentsMap);
        
    } catch (error) {
        console.error('Erreur:', error);
        if (cachedData) {
            renderInterventions(cachedData.interventions, cachedData.validationMap, cachedData.employeesMap, cachedData.appointmentsMap);
        } else {
            container.innerHTML = '<div class="text-center py-8 text-red-500"><p>Erreur lors du chargement</p></div>';
        }
    }
}

// ===== RENDER INTERVENTIONS =====
function renderInterventions(interventions, validationMap, employeesMap, appointmentsMap) {
    const container = document.getElementById('interventions-list');
    
    container.innerHTML = interventions.map(intervention => {
        const appointment = intervention.appointment_id ? appointmentsMap[intervention.appointment_id] : null;
        const employeeId = intervention.technician_id || appointment?.employee_id;
        const employee = employeeId ? employeesMap[employeeId] : null;
        const technicianName = employee 
            ? `${employee.first_name || ''} ${employee.last_name || ''}`.trim() 
            : 'Technicien inconnu';
        
        // Calculer le score de qualit√© bas√© sur les validations IA
        const validations = validationMap[intervention.id] || [];
        const validatedCount = validations.filter(v => v.validation_status === 'validated').length;
        const partialCount = validations.filter(v => v.validation_status === 'partial').length;
        const rejectedCount = validations.filter(v => v.validation_status === 'rejected').length;
        const totalValidations = validations.length;
        
        // Score : validated = 100%, partial = 50%, rejected = 0%
        let qualityScore = 0;
        if (totalValidations > 0) {
            qualityScore = Math.round(
                ((validatedCount * 100 + partialCount * 50 + rejectedCount * 0) / totalValidations)
            );
        } else {
            // Si pas de validation, score bas√© sur le nombre de photos (11 photos attendues)
            const photoCount = totalValidations; // On utilise le nombre de validations comme proxy
            qualityScore = photoCount >= 11 ? 100 : Math.round((photoCount / 11) * 100);
        }
        
        // D√©terminer le statut
        let status = 'A valider';
        let statusColor = 'bg-primary/10 text-primary';
        let statusText = 'A valider';
        let isValidated = false;
        let cardOpacity = '';
        let cardBorder = 'border-border-light dark:border-border-dark';
        
        if (intervention.status === 'completed' || intervention.status === 'validated') {
            status = 'Valid√©';
            statusColor = 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400';
            statusText = 'Valid√©';
            isValidated = true;
            cardOpacity = 'opacity-60';
            cardBorder = 'border-green-300 dark:border-green-700';
        } else if (intervention.status === 'rejected') {
            status = 'Refus√©';
            statusColor = 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400';
            statusText = 'Refus√©';
            cardOpacity = 'opacity-70';
            cardBorder = 'border-red-400 dark:border-red-600 border-2';
        } else if (qualityScore < 50) {
            status = 'Action requise';
            statusColor = 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400';
            statusText = 'Action requise';
        }
        
        // Format de la date
        const createdDate = new Date(intervention.created_at);
        const dateStr = createdDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        const timeStr = createdDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        
        // Adresse
        const address = intervention.address || appointment?.address || 'Adresse non disponible';
        
        // Commentaire/description
        const comment = intervention.comments || 'Aucun commentaire';
        
        // Photo du technicien
        const photoUrl = employee?.photo_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(technicianName) + '&background=135bec&color=fff';
        
        return `
            <article class="group relative flex flex-col gap-3 rounded-2xl bg-surface-light dark:bg-surface-dark p-4 shadow-sm border ${cardBorder} ${cardOpacity} active:scale-[0.98] transition-all duration-200 ${canEdit ? 'cursor-pointer' : ''}" 
                    onclick="${canEdit ? `openInterventionDetails('${intervention.id}')` : ''}">
                <div class="flex justify-between items-start">
                    <div class="flex gap-3">
                        <div class="h-12 w-12 rounded-full bg-gray-200 dark:bg-gray-700 bg-cover bg-center shrink-0 border-2 border-white dark:border-gray-600 shadow-sm ${isValidated ? 'opacity-70' : ''}" 
                             style="background-image: url('${photoUrl}')">
                        </div>
                        <div>
                            <h3 class="font-bold text-text-main-light dark:text-text-main-dark leading-tight ${isValidated ? 'line-through opacity-60' : ''}">${technicianName}</h3>
                            <p class="text-xs font-medium text-text-sub-light dark:text-text-sub-dark mt-0.5">${dateStr} ‚Ä¢ ${timeStr}</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="inline-flex items-center gap-1 rounded-full ${statusColor} px-2.5 py-0.5 text-xs font-bold">
                            ${statusText}
                        </span>
                    </div>
                </div>
                <div class="flex items-start gap-2 text-text-sub-light dark:text-text-sub-dark">
                    <span class="material-symbols-outlined text-[20px] shrink-0 text-text-sub-light dark:text-text-sub-dark">location_on</span>
                    <p class="text-sm">${address}</p>
                </div>
                <p class="text-sm text-text-sub-light dark:text-text-sub-dark line-clamp-1">
                    ${comment}
                </p>
            </article>
        `;
    }).join('');
}

// ===== OPEN INTERVENTION DETAILS =====
function openInterventionDetails(interventionId) {
    if (!canEdit) return;
    // Rediriger vers la page de d√©tails du chef de chantier
    window.location.href = `chefdetails.html?id=${interventionId}`;
}

// ===== LOGOUT =====
async function handleLogout() {
    if (window.supabase) {
        await window.supabase.auth.signOut();
    }
    window.location.href = 'index.html';
}
</script>

</body></html>
